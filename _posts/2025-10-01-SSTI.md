---
layout: post
title:  "SSTI - [WesternCTF 2018] Shrine "
date:   2025-10-01 12:00:00 +0700
tags: PortSwigger
categories: jekyll update
---


# SSTI 

## [WesternCTF 2018] Shrine 

```python
import flask
import os 

app = flask.Flask(__name__)

app.config['FLAG'] = os.environ.get('FLAG')

@app.route('/')
def index():
    return open(__file__).read()

@app.route('/shrine')
def shrine(shrine):
    def safe_jinja(s):
        s = s.replace('(', '').replace(')', '')
        blacklist=['config','self']
        return ''.join(['{{% set {}=None%}}'.format(c) for c in blacklist]) + s
    return flask.render_template_string(safe_jinja(shrine))

if __name__ == '__main__':
    app.run(debug=True)
``` 

Bài này bị `SSTI` tại hàm `safe_jinja` khi mà chặn blacklist thì nó đã viết sai cú pháp, cú pháp đúng phải là `{% %}`.

Lí do tác giả muốn set trước khi nối vào trước user input để trở thành `{{% set config=None %}}``{{% set self=None %}}` + `<user_input>`

Cho nên mình thử payload là: `{{7*7}}`

![image](https://hackmd.io/_uploads/H16rqZKnxg.png)

Từ đây, mình có thể dùng `url_for` thì nó là 1 helper trong Flask được dùng để tạo URL động và do ko có chặn `__globals__` nên mình có thể dùng nó.

![image](https://hackmd.io/_uploads/S1gR5ZFhlg.png)

Thì thấy có `current_app`, do trong ứng dụng có `app=flask.Flask(__name__)`. 

Cho nên mình có thể chạy payload như sau: 

![image](https://hackmd.io/_uploads/Bk5Yi-Yhlx.png)
